<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¬ Admin â€” Movie Time Festival 2026</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root{
  --void:#050507;--ink:#0d0d12;--charcoal:#141419;--carbon:#1c1c24;
  --graphite:#252530;--steel:#34343f;--iron:#4a4a58;--ash:#6b6b7e;
  --silver:#a0a0b8;--mist:#c8c8dc;--ghost:#e8e8f0;--white:#f8f8ff;
  --flame:#ff6b00;--amber:#ff8c42;--gold:#ffb347;
  --green:#00e676;--red:#ff1744;--yellow:#ffd600;--blue:#00b0ff;
  --r:12px;--r-sm:8px;--r-lg:20px;
  --font:'Syne',sans-serif;--mono:'DM Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--void);color:var(--ghost);min-height:100vh;overflow-x:hidden}
.hidden{display:none!important}

/* â”€â”€ LAYOUT â”€â”€ */
.app-grid{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
@media(max-width:768px){.app-grid{grid-template-columns:1fr}.sidebar{display:none}}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{background:var(--ink);border-right:1px solid var(--graphite);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}
.sb-logo{padding:1.5rem 1.25rem;border-bottom:1px solid var(--graphite)}
.sb-logo h2{font-size:1rem;font-weight:800;background:linear-gradient(135deg,var(--amber),var(--flame));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.3}
.sb-logo p{font-size:.62rem;color:var(--iron);margin-top:3px;letter-spacing:.12em;text-transform:uppercase}
.sb-nav{padding:.75rem;flex:1}
.nav-section{padding:8px 12px 4px;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--iron);margin-top:8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r-sm);color:var(--ash);font-size:.82rem;font-weight:600;cursor:pointer;margin-bottom:4px;transition:all .18s;border:1px solid transparent;user-select:none}
.nav-item:hover{background:var(--carbon);color:var(--mist)}
.nav-item.active{background:rgba(255,107,0,.1);color:var(--amber);border-color:rgba(255,107,0,.2)}
.nav-item.danger-nav{color:rgba(255,23,68,.7)}
.nav-item.danger-nav:hover{background:rgba(255,23,68,.08);color:var(--red);border-color:rgba(255,23,68,.2)}
.nav-badge{margin-left:auto;border-radius:50px;padding:2px 7px;font-size:.62rem;font-weight:800;min-width:18px;text-align:center}
.sb-footer{padding:1rem 1.25rem;border-top:1px solid var(--graphite)}
.sb-admin-label{font-size:.62rem;color:var(--iron);text-transform:uppercase;letter-spacing:.1em}
.sb-admin-email{font-size:.78rem;color:var(--silver);margin-top:3px;word-break:break-all}
.sb-logout{margin-top:10px;width:100%;background:transparent;border:1px solid var(--steel);border-radius:var(--r-sm);padding:7px;color:var(--silver);font-family:var(--font);font-size:.72rem;font-weight:600;cursor:pointer;transition:all .18s}
.sb-logout:hover{background:rgba(255,23,68,.1);border-color:var(--red);color:var(--red)}

/* â”€â”€ MAIN â”€â”€ */
.main{display:flex;flex-direction:column;overflow-x:hidden;min-height:100vh}
.topbar{background:var(--ink);border-bottom:1px solid var(--graphite);padding:.875rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:10px}
.topbar h1{font-size:.95rem;font-weight:700;color:var(--white)}
.admin-pill{background:rgba(255,107,0,.15);border:1px solid rgba(255,107,0,.3);border-radius:50px;padding:3px 12px;font-size:.65rem;font-weight:700;color:var(--amber)}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s ease-in-out infinite;flex-shrink:0}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.content{padding:1.25rem;flex:1}

/* â”€â”€ LOGIN â”€â”€ */
.login-overlay{position:fixed;inset:0;background:var(--void);display:flex;align-items:center;justify-content:center;z-index:999;padding:1.5rem}
.login-card{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r-lg);padding:2.5rem 2rem;width:100%;max-width:380px}
.login-icon{text-align:center;font-size:3rem;margin-bottom:1rem}
.login-card h2{font-size:1.5rem;font-weight:800;color:var(--white);text-align:center;margin-bottom:4px}
.login-card .subtitle{font-size:.75rem;color:var(--ash);text-align:center;margin-bottom:1.75rem}
.lf{margin-bottom:1rem}
.ll{display:block;font-size:.65rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ash);margin-bottom:6px}
.li{width:100%;background:var(--graphite);border:2px solid var(--steel);border-radius:var(--r-sm);padding:12px 14px;color:var(--white);font-family:var(--font);font-size:.9rem;transition:border-color .2s}
.li:focus{outline:none;border-color:var(--flame)}
.login-btn{width:100%;background:linear-gradient(135deg,var(--flame),#ff4500);color:#fff;border:none;border-radius:var(--r-sm);padding:13px;font-family:var(--font);font-size:1rem;font-weight:700;cursor:pointer;margin-top:6px;transition:opacity .2s}
.login-btn:hover{opacity:.9}
.login-btn:disabled{opacity:.5;cursor:not-allowed}
.login-err{color:var(--red);font-size:.78rem;margin-top:10px;text-align:center;min-height:20px}
.login-hint{background:rgba(255,107,0,.06);border:1px solid rgba(255,107,0,.15);border-radius:var(--r-sm);padding:10px 14px;margin-top:1.25rem}
.login-hint p{font-size:.72rem;color:var(--ash);line-height:1.7}
.login-hint strong{color:var(--amber)}
.login-hint .cred-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.copy-cred{background:transparent;border:none;color:var(--flame);cursor:pointer;font-size:.75rem;font-family:var(--font);font-weight:600;padding:0;text-decoration:underline}

/* â”€â”€ STATS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.875rem;margin-bottom:1.25rem}
.stat{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r);padding:1rem;position:relative;overflow:hidden}
.stat-label{font-size:.62rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ash);margin-bottom:6px}
.stat-val{font-size:2rem;font-weight:800}
.stat.s-orange .stat-val{color:var(--amber)}
.stat.s-green  .stat-val{color:var(--green)}
.stat.s-yellow .stat-val{color:var(--yellow)}
.stat.s-red    .stat-val{color:var(--red)}

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar{display:flex;gap:8px;margin-bottom:1rem;flex-wrap:wrap;align-items:center}
.filter-btn{padding:7px 14px;border-radius:50px;font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;border:1px solid var(--steel);background:transparent;color:var(--ash);transition:all .18s;white-space:nowrap}
.filter-btn:hover{background:var(--graphite);color:var(--mist)}
.filter-btn.active{background:rgba(255,107,0,.15);border-color:rgba(255,107,0,.4);color:var(--amber)}
.search-box{flex:1;min-width:160px;background:var(--carbon);border:1px solid var(--steel);border-radius:var(--r-sm);padding:7px 12px;color:var(--white);font-family:var(--font);font-size:.82rem}
.search-box:focus{outline:none;border-color:var(--flame)}
.icon-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r-sm);font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;border:1px solid var(--steel);background:var(--graphite);color:var(--silver);transition:all .18s;white-space:nowrap}
.icon-btn:hover{background:var(--steel);color:var(--white)}

/* â”€â”€ TABLE â”€â”€ */
.table-wrap{border-radius:var(--r);border:1px solid var(--graphite);overflow:hidden}
.table-inner{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.78rem}
thead{background:var(--charcoal);border-bottom:1px solid var(--graphite)}
th{padding:11px 12px;text-align:left;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);white-space:nowrap}
tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:background .12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.025)}
td{padding:11px 12px;vertical-align:middle}
.td-mono{font-family:var(--mono);font-size:.72rem}
.td-name{font-weight:600;color:var(--white)}
.td-muted{color:var(--silver);font-size:.75rem}
.pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:50px;font-size:.62rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;white-space:nowrap}
.pill-pending {background:rgba(255,214,0,.1); color:var(--yellow);border:1px solid rgba(255,214,0,.25)}
.pill-approved{background:rgba(0,230,118,.1); color:var(--green); border:1px solid rgba(0,230,118,.25)}
.pill-rejected{background:rgba(255,23,68,.1);  color:var(--red);  border:1px solid rgba(255,23,68,.25)}
.act-wrap{display:flex;gap:5px;flex-wrap:nowrap}
.ab{padding:5px 9px;border-radius:6px;font-family:var(--font);font-size:.65rem;font-weight:700;cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.ab-view    {background:var(--graphite);color:var(--silver);border:1px solid var(--steel)}
.ab-view:hover{background:var(--steel)}
.ab-approve {background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.3)}
.ab-approve:hover{background:rgba(0,230,118,.25)}
.ab-reject  {background:rgba(255,23,68,.1); color:var(--red);  border:1px solid rgba(255,23,68,.25)}
.ab-reject:hover{background:rgba(255,23,68,.22)}
.ab-delete  {background:rgba(255,23,68,.06);color:rgba(255,23,68,.8);border:1px solid rgba(255,23,68,.15)}
.ab-delete:hover{background:rgba(255,23,68,.18);color:var(--red)}
.empty-state{text-align:center;padding:3rem 1rem;color:var(--ash)}
.empty-icon{font-size:2.5rem;margin-bottom:.75rem}
.empty-text{font-size:.88rem}

/* â”€â”€ MODAL â”€â”€ */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:800;display:flex;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r-lg);width:100%;max-width:640px;max-height:92vh;overflow-y:auto;display:flex;flex-direction:column}
.modal-hd{padding:1.25rem 1.5rem;border-bottom:1px solid var(--graphite);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--carbon);z-index:10}
.modal-hd h3{font-size:1rem;font-weight:700}
.modal-close-btn{background:var(--graphite);border:none;color:var(--silver);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
.modal-close-btn:hover{background:var(--steel)}
.modal-body{padding:1.5rem;flex:1}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.di{background:var(--graphite);border-radius:var(--r-sm);padding:.875rem}
.di label{display:block;font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ash);margin-bottom:4px}
.di span{font-size:.82rem;color:var(--white);word-break:break-all;line-height:1.4}
.di.wide{grid-column:1/-1}
.sec-title{font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin:1.25rem 0 .75rem;display:flex;align-items:center;gap:8px}
.modal-ft{padding:1rem 1.5rem;border-top:1px solid var(--graphite);display:flex;gap:8px;flex-wrap:wrap;position:sticky;bottom:0;background:var(--carbon)}
.mab{flex:1;min-width:80px;padding:11px;border-radius:var(--r-sm);font-family:var(--font);font-size:.8rem;font-weight:700;cursor:pointer;border:none;transition:all .18s;text-align:center}
.mab-approve{background:linear-gradient(135deg,#00c853,var(--green));color:#000}
.mab-approve:hover{opacity:.9}
.mab-reject {background:linear-gradient(135deg,#d50000,var(--red));color:#fff}
.mab-reject:hover{opacity:.9}
.mab-delete {background:rgba(255,23,68,.1);color:var(--red);border:1px solid rgba(255,23,68,.3)}
.mab-delete:hover{background:rgba(255,23,68,.25)}
.mab-close  {background:var(--graphite);color:var(--silver);border:1px solid var(--steel)}
.mab-close:hover{background:var(--steel)}

/* â”€â”€ SCREENSHOT + OCR â”€â”€ */
.screenshot-wrap{position:relative;border-radius:var(--r-sm);overflow:hidden;border:1px solid var(--steel)}
.screenshot-img{width:100%;display:block;cursor:zoom-in;max-height:280px;object-fit:contain;background:#000}
.screenshot-expand{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.75);border:none;color:#fff;border-radius:6px;padding:4px 10px;font-size:.68rem;cursor:pointer;font-family:var(--font);font-weight:600}
.ocr-panel{background:var(--graphite);border-radius:var(--r-sm);padding:1rem;margin-top:.75rem;border:1px solid var(--steel)}
.ocr-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:.875rem}
.ocr-info-title{font-size:.7rem;font-weight:700;color:var(--blue);letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px}
.ocr-info-sub{font-size:.68rem;color:var(--ash)}
.ocr-scan-btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:var(--r-sm);background:rgba(0,176,255,.1);border:1px solid rgba(0,176,255,.3);color:var(--blue);font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;flex-shrink:0;white-space:nowrap}
.ocr-scan-btn:hover:not(:disabled){background:rgba(0,176,255,.2)}
.ocr-scan-btn:disabled{opacity:.45;cursor:not-allowed}
.ocr-prog{display:none;margin-bottom:.75rem}
.ocr-bar-track{background:var(--steel);border-radius:50px;height:5px;overflow:hidden;margin-bottom:5px}
.ocr-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),#00e5ff);border-radius:50px;transition:width .3s;width:0%}
.ocr-prog-txt{font-size:.68rem;color:var(--ash)}
.ocr-res{display:none}
.ocr-cmp{display:grid;grid-template-columns:1fr 1fr;gap:.625rem;margin-bottom:.75rem}
.ocr-col{background:var(--carbon);border-radius:var(--r-sm);padding:.75rem}
.ocr-col-lbl{font-size:.6rem;color:var(--ash);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;font-weight:700}
.ocr-col-val{font-family:var(--mono);font-size:.8rem;color:var(--white);word-break:break-all;min-height:1.1em}
.match-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:50px;font-size:.75rem;font-weight:700;margin-bottom:.5rem}
.mp-yes    {background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.3)}
.mp-no     {background:rgba(255,23,68,.1); color:var(--red);  border:1px solid rgba(255,23,68,.25)}
.mp-partial{background:rgba(255,214,0,.1);color:var(--yellow);border:1px solid rgba(255,214,0,.25)}
.mp-unknown{background:rgba(255,255,255,.06);color:var(--silver);border:1px solid var(--steel)}
.ocr-raw{font-size:.68rem;color:var(--ash);max-height:90px;overflow-y:auto;background:var(--carbon);padding:.5rem .625rem;border-radius:var(--r-sm);word-break:break-all;white-space:pre-wrap;font-family:var(--mono);margin-top:.5rem}

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
.confirm-bg{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:900;display:flex;align-items:center;justify-content:center;padding:1.5rem;backdrop-filter:blur(4px)}
.confirm-box{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r-lg);padding:2rem;max-width:380px;width:100%;text-align:center}
.conf-icon{font-size:2.5rem;margin-bottom:.875rem}
.confirm-box h3{font-size:1.15rem;font-weight:700;color:var(--white);margin-bottom:.5rem}
.confirm-box p{font-size:.8rem;color:var(--silver);line-height:1.65;margin-bottom:1.25rem}
.conf-inp{width:100%;background:var(--graphite);border:2px solid var(--steel);border-radius:var(--r-sm);padding:10px 12px;color:var(--white);font-family:var(--mono);font-size:.85rem;margin-bottom:1.25rem;text-align:center;letter-spacing:.05em}
.conf-inp:focus{outline:none;border-color:var(--red)}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:11px;border-radius:var(--r-sm);font-family:var(--font);font-size:.85rem;font-weight:700;cursor:pointer;border:none;transition:all .18s}
.btn-cancel{background:var(--graphite);color:var(--silver)}
.btn-cancel:hover{background:var(--steel)}
.btn-danger{background:linear-gradient(135deg,#b71c1c,var(--red));color:#fff}
.btn-danger:hover{opacity:.9}
.btn-danger:disabled{opacity:.4;cursor:not-allowed}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);padding:8px 20px;border-radius:50px;font-size:.78rem;font-weight:700;z-index:9999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{background:var(--green);color:#000}
.toast.error  {background:var(--red);  color:#fff}
.toast.info   {background:var(--blue); color:#000}
.toast.warn   {background:var(--yellow);color:#000}

/* â”€â”€ SPINNER â”€â”€ */
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:currentColor;border-radius:50%;animation:rot .6s linear infinite;vertical-align:middle}
@keyframes rot{to{transform:rotate(360deg)}}
.loading-state{text-align:center;padding:2.5rem 1rem;color:var(--ash);font-size:.85rem}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="login-overlay" id="login-overlay">
  <div class="login-card">
    <div class="login-icon">ğŸ¬</div>
    <h2>Admin Login</h2>
    <p class="subtitle">Movie Time Festival 2026 Â· Booking Management</p>
    <div class="lf">
      <label class="ll" for="l-email">Email Address</label>
      <input type="email" id="l-email" class="li" placeholder="admin@email.com" autocomplete="email" value="pradeephegde432@gmail.com">
    </div>
    <div class="lf">
      <label class="ll" for="l-pass">Password</label>
      <input type="password" id="l-pass" class="li" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <button class="login-btn" id="login-btn" onclick="doLogin()">Sign In â†’</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-hint">
      <p>
        <strong>ğŸ”‘ Admin Credentials</strong><br>
        <span class="cred-row">
          <span>ğŸ“§ pradeephegde432@gmail.com</span>
          <button class="copy-cred" onclick="copyText('pradeephegde432@gmail.com')">Copy</button>
        </span>
        <span class="cred-row">
          <span>ğŸ” Password: MovieAdmin@2026</span>
          <button class="copy-cred" onclick="copyText('MovieAdmin@2026')">Copy</button>
        </span>
      </p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-grid hidden" id="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-logo">
      <h2>ğŸ¬ MOVIE TIME<br>ADMIN</h2>
      <p>Festival 2026</p>
    </div>
    <nav class="sb-nav">
      <div class="nav-section">Bookings</div>
      <div class="nav-item active" id="nav-all"      onclick="navTo('all',event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
        All Bookings
        <span class="nav-badge" id="nb-all" style="background:var(--flame);color:#000">0</span>
      </div>
      <div class="nav-item" id="nav-pending" onclick="navTo('pending',event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Pending
        <span class="nav-badge" id="nb-pending" style="background:var(--yellow);color:#000">0</span>
      </div>
      <div class="nav-item" id="nav-approved" onclick="navTo('approved',event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Approved
        <span class="nav-badge" id="nb-approved" style="background:var(--green);color:#000">0</span>
      </div>
      <div class="nav-item" id="nav-rejected" onclick="navTo('rejected',event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        Rejected
        <span class="nav-badge" id="nb-rejected" style="background:var(--red);color:#fff">0</span>
      </div>

      <div class="nav-section" style="margin-top:16px">Danger Zone</div>
      <div class="nav-item danger-nav" onclick="confirmClearDB()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        Clear Database
      </div>
    </nav>
    <div class="sb-footer">
      <div class="sb-admin-label">Signed in as</div>
      <div class="sb-admin-email" id="admin-email">â€”</div>
      <button class="sb-logout" onclick="doLogout()">ğŸšª Sign Out</button>
    </div>
  </aside>

  <!-- MAIN PANEL -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <div class="live-dot" title="Live"></div>
        <h1 id="page-title">All Bookings</h1>
      </div>
      <span class="admin-pill">Admin Dashboard</span>
    </div>
    <div class="content">

      <!-- STATS -->
      <div class="stats-grid">
        <div class="stat s-orange"><div class="stat-label">Total Bookings</div><div class="stat-val" id="s-total">â€”</div></div>
        <div class="stat s-yellow"><div class="stat-label">Pending</div><div class="stat-val" id="s-pending">â€”</div></div>
        <div class="stat s-green" ><div class="stat-label">Approved</div><div class="stat-val" id="s-approved">â€”</div></div>
        <div class="stat s-red"   ><div class="stat-label">Rejected</div><div class="stat-val" id="s-rejected">â€”</div></div>
        <div class="stat s-orange"><div class="stat-label">Total Tickets</div><div class="stat-val" id="s-tickets">â€”</div></div>
        <div class="stat s-green" ><div class="stat-label">Revenue (â‚¹)</div><div class="stat-val" id="s-revenue">â€”</div></div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <button class="filter-btn active" id="fb-all"      onclick="setFilter('all')">All</button>
        <button class="filter-btn"         id="fb-pending"  onclick="setFilter('pending')">â³ Pending</button>
        <button class="filter-btn"         id="fb-approved" onclick="setFilter('approved')">âœ… Approved</button>
        <button class="filter-btn"         id="fb-rejected" onclick="setFilter('rejected')">âŒ Rejected</button>
        <input  type="text" class="search-box" id="search-box" placeholder="Search name, email, UTR, booking IDâ€¦" oninput="applySearch(this.value)">
        <button class="icon-btn" onclick="loadBookings()">â†» Refresh</button>
      </div>

      <!-- TABLE -->
      <div id="table-area">
        <div class="loading-state"><span class="spin"></span> Loading bookingsâ€¦</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOOKING MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg hidden" id="modal-bg">
  <div class="modal">
    <div class="modal-hd">
      <h3 id="modal-title">Booking Details</h3>
      <button class="modal-close-btn" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="modal-grid"></div>

      <!-- SCREENSHOT -->
      <div id="modal-screenshot-sec" style="display:none">
        <div class="sec-title">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Payment Screenshot
        </div>
        <div class="screenshot-wrap">
          <img id="modal-img" class="screenshot-img" src="" alt="Screenshot" onclick="window.open(this.src,'_blank')">
          <button class="screenshot-expand" onclick="window.open(document.getElementById('modal-img').src,'_blank')">â¤¢ Full</button>
        </div>

        <!-- OCR PANEL -->
        <div class="ocr-panel">
          <div class="ocr-header">
            <div>
              <div class="ocr-info-title">ğŸ” UTR Verification via OCR</div>
              <div class="ocr-info-sub">Scan screenshot text and auto-compare with submitted UTR</div>
            </div>
            <button class="ocr-scan-btn" id="ocr-btn" onclick="runOCR()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
              Scan (OCR)
            </button>
          </div>
          <div class="ocr-prog" id="ocr-prog">
            <div class="ocr-bar-track"><div class="ocr-bar-fill" id="ocr-bar"></div></div>
            <div class="ocr-prog-txt" id="ocr-prog-txt">Initialisingâ€¦</div>
          </div>
          <div class="ocr-res" id="ocr-res">
            <div class="ocr-cmp">
              <div class="ocr-col">
                <div class="ocr-col-lbl">Submitted UTR</div>
                <div class="ocr-col-val" id="ocr-submitted">â€”</div>
              </div>
              <div class="ocr-col">
                <div class="ocr-col-lbl">Detected in Image</div>
                <div class="ocr-col-val" id="ocr-detected">â€”</div>
              </div>
            </div>
            <div id="ocr-verdict"></div>
            <div style="margin-top:.75rem">
              <div style="font-size:.62rem;color:var(--ash);text-transform:uppercase;letter-spacing:.1em;font-weight:700;margin-bottom:4px">Full Extracted Text</div>
              <div class="ocr-raw" id="ocr-raw-text">â€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-ft">
      <button class="mab mab-approve" id="modal-approve" onclick="modalAction('approved')">âœ… Approve</button>
      <button class="mab mab-reject"  id="modal-reject"  onclick="modalAction('rejected')">âŒ Reject</button>
      <button class="mab mab-delete"  onclick="modalDelete()">ğŸ—‘ Delete</button>
      <button class="mab mab-close"   onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIRM DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="confirm-bg hidden" id="conf-bg">
  <div class="confirm-box">
    <div class="conf-icon" id="conf-icon">âš ï¸</div>
    <h3 id="conf-title">Are you sure?</h3>
    <p id="conf-msg">This cannot be undone.</p>
    <input type="text" id="conf-inp" class="conf-inp" placeholder="" style="display:none">
    <div class="confirm-btns">
      <button class="btn-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="btn-danger" id="conf-ok" onclick="executeConfirm()">Confirm</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB     = 'https://vjxidlnggrpbttxmrfch.supabase.co';
const AKEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqeGlkbG5nZ3JwYnR0eG1yZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjQ2MzYsImV4cCI6MjA4NzAwMDYzNn0.G7OXaE8hi-1ELJAmw_-gLi658henIj2NjIBqFd3HWWo';
const BUCKET = 'payment-screenshots';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authToken    = null;
let allBookings  = [];
let curFilter    = 'all';
let curSearch    = '';
let modalBooking = null;
let confirmAction = null;
let confirmRequireInput = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $  = id => document.getElementById(id);
const esc = s  => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function toast(msg, type='success'){
  const el = $('toast');
  el.textContent = msg;
  el.className   = 'toast show ' + type;
  clearTimeout(el._tid);
  el._tid = setTimeout(() => el.classList.remove('show'), 2800);
}

function hdrs(requireAuth){
  const tok = requireAuth ? authToken : (authToken || AKEY);
  return { 'apikey': AKEY, 'Authorization': 'Bearer '+(tok||AKEY), 'Content-Type': 'application/json' };
}

function copyText(t){
  navigator.clipboard?.writeText(t).catch(()=>{});
  toast('Copied!','info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const email = $('l-email').value.trim();
  const pass  = $('l-pass').value;
  const btn   = $('login-btn');
  const errEl = $('login-err');
  errEl.textContent = '';
  if(!email || !pass){ errEl.textContent = 'âš ï¸ Enter both email and password.'; return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Signing inâ€¦';
  try {
    const res  = await fetch(`${SB}/auth/v1/token?grant_type=password`,{
      method: 'POST',
      headers: { 'apikey': AKEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();
    if(!res.ok || data.error){
      errEl.textContent = data.error_description || data.msg || 'Invalid email or password.';
      return;
    }
    authToken = data.access_token;
    $('login-overlay').classList.add('hidden');
    $('app').classList.remove('hidden');
    $('admin-email').textContent = email;
    loadBookings();
  } catch {
    errEl.textContent = 'ğŸŒ Network error â€” check your connection.';
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Sign In â†’';
  }
}

function doLogout(){
  authToken = null;
  allBookings = [];
  $('app').classList.add('hidden');
  $('login-overlay').classList.remove('hidden');
  $('l-pass').value = '';
  $('login-err').textContent = '';
}

$('l-pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
$('l-email').addEventListener('keydown', e => { if(e.key==='Enter') $('l-pass').focus(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH BOOKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBookings(){
  $('table-area').innerHTML = '<div class="loading-state"><span class="spin"></span> Fetching bookingsâ€¦</div>';
  try {
    const res = await fetch(`${SB}/rest/v1/ticket_bookings?select=*&order=submitted_at.desc`, { headers: hdrs(false) });
    if(!res.ok) throw new Error('HTTP ' + res.status + ' â€” ' + await res.text());
    allBookings = await res.json();
    updateStats();
    applyFilters();
  } catch(e) {
    $('table-area').innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-text" style="color:var(--red)">${esc(e.message)}</div></div>`;
    toast('Failed to load: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats(){
  const n = s => allBookings.filter(b => b.approval_status === s).length;
  const total    = allBookings.length;
  const pending  = n('pending');
  const approved = n('approved');
  const rejected = n('rejected');
  const tickets  = allBookings.reduce((s,b) => s + (b.quantity||0), 0);
  const revenue  = allBookings.filter(b=>b.approval_status==='approved').reduce((s,b)=>s+(b.total_amount||0),0);

  $('s-total').textContent    = total;
  $('s-pending').textContent  = pending;
  $('s-approved').textContent = approved;
  $('s-rejected').textContent = rejected;
  $('s-tickets').textContent  = tickets;
  $('s-revenue').textContent  = 'â‚¹' + revenue;

  $('nb-all').textContent      = total;
  $('nb-pending').textContent  = pending;
  $('nb-approved').textContent = approved;
  $('nb-rejected').textContent = rejected;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navTo(v, e){
  e?.stopPropagation();
  ['all','pending','approved','rejected'].forEach(x => {
    $('nav-'+x)?.classList.toggle('active', x===v);
  });
  const titles = {all:'All Bookings',pending:'Pending Approval',approved:'Approved',rejected:'Rejected'};
  $('page-title').textContent = titles[v] || v;
  setFilter(v);
}

function setFilter(f){
  curFilter = f;
  ['all','pending','approved','rejected'].forEach(x => $('fb-'+x)?.classList.toggle('active', x===f));
  applyFilters();
}

function applySearch(val){
  curSearch = val.toLowerCase();
  applyFilters();
}

function applyFilters(){
  const list = allBookings.filter(b => {
    if(curFilter !== 'all' && b.approval_status !== curFilter) return false;
    if(curSearch){
      const hay = [b.name, b.email, b.booking_id, b.transaction_id, b.phone].join(' ').toLowerCase();
      if(!hay.includes(curSearch)) return false;
    }
    return true;
  });
  renderTable(list);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(list){
  if(!list.length){
    $('table-area').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸŸï¸</div><div class="empty-text">No bookings match your filter.</div></div>';
    return;
  }
  $('table-area').innerHTML = `
    <div class="table-wrap">
      <div class="table-inner">
        <table>
          <thead><tr>
            <th>#</th><th>Booking ID</th><th>Name</th><th>Email</th>
            <th>Qty</th><th>Amount</th><th>UTR / Transaction</th>
            <th>Submitted</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody>${list.map((b,i) => rowHtml(b,i+1)).join('')}</tbody>
        </table>
      </div>
    </div>`;
}

function pillHtml(s){
  const c = {pending:'pill-pending',approved:'pill-approved',rejected:'pill-rejected'};
  const i = {pending:'â³',approved:'âœ…',rejected:'âŒ'};
  return `<span class="pill ${c[s]||'pill-pending'}">${i[s]||''} ${s||'pending'}</span>`;
}

function rowHtml(b, n){
  const dt = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'short'}) : 'â€”';
  const ip = b.approval_status === 'pending';
  return `<tr>
    <td style="color:var(--ash);font-size:.72rem">${n}</td>
    <td><span class="td-mono">${esc(b.booking_id||'â€”')}</span></td>
    <td class="td-name">${esc(b.name||'â€”')}</td>
    <td class="td-muted">${esc(b.email||'â€”')}</td>
    <td style="text-align:center;font-weight:700">${b.quantity||'â€”'}</td>
    <td style="color:var(--amber);font-weight:700">â‚¹${b.total_amount||'â€”'}</td>
    <td><span class="td-mono">${esc(b.transaction_id||'â€”')}</span></td>
    <td class="td-muted">${dt}</td>
    <td>${pillHtml(b.approval_status)}</td>
    <td>
      <div class="act-wrap">
        <button class="ab ab-view"    onclick="openModal('${b.id}')">ğŸ‘</button>
        ${ip ? `
          <button class="ab ab-approve" onclick="updateStatus('${b.id}','approved')">âœ…</button>
          <button class="ab ab-reject"  onclick="updateStatus('${b.id}','rejected')">âŒ</button>
        ` : ''}
        <button class="ab ab-delete" onclick="confirmDeleteBooking('${b.id}')">ğŸ—‘</button>
      </div>
    </td>
  </tr>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){
  const b = allBookings.find(x => x.id === id);
  if(!b) return;
  modalBooking = b;

  $('modal-title').textContent = 'Booking â€” ' + (b.booking_id || id);

  const fields = [
    ['Name',           b.name],
    ['Email',          b.email],
    ['Phone',          b.phone],
    ['Booking ID',     b.booking_id],
    ['Tickets',        (b.quantity||'?') + ' ticket(s)'],
    ['Total Paid',     'â‚¹' + (b.total_amount||'?')],
    ['Event',          b.event_name],
    ['Date & Time',    (b.event_date||'') + ' Â· ' + (b.event_time||'')],
    ['Venue',          b.venue],
    ['Status',         b.approval_status],
    ['Submitted At',   b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN') : 'â€”'],
    ['Approved At',    b.approved_at  ? new Date(b.approved_at).toLocaleString('en-IN')  : 'â€”'],
    ['UTR / Transaction ID', b.transaction_id, true],
    ['Approved By',    b.approved_by || 'â€”', true],
  ];

  $('modal-grid').innerHTML = fields.map(([l,v,wide]) =>
    `<div class="di${wide?' wide':''}"><label>${esc(l)}</label><span>${esc(String(v||'â€”'))}</span></div>`
  ).join('');

  // Screenshot section
  const secEl = $('modal-screenshot-sec');
  if(b.screenshot_url){
    secEl.style.display = '';
    $('modal-img').src = b.screenshot_url;
    // Reset OCR UI
    $('ocr-prog').style.display = 'none';
    $('ocr-res').style.display  = 'none';
    $('ocr-bar').style.width    = '0%';
    const btn = $('ocr-btn');
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg> Scan (OCR)';
    $('ocr-submitted').textContent = (b.transaction_id||'â€”').toUpperCase();
  } else {
    secEl.style.display = 'none';
  }

  const ip = b.approval_status === 'pending';
  $('modal-approve').style.display = ip ? '' : 'none';
  $('modal-reject').style.display  = ip ? '' : 'none';

  $('modal-bg').classList.remove('hidden');
}

function closeModal(){
  $('modal-bg').classList.add('hidden');
  modalBooking = null;
}

$('modal-bg').addEventListener('click', e => { if(e.target === $('modal-bg')) closeModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OCR â€” SCREENSHOT vs UTR COMPARISON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runOCR(){
  const b = modalBooking;
  if(!b?.screenshot_url) return;

  const btn  = $('ocr-btn');
  const prog = $('ocr-prog');
  const res  = $('ocr-res');

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Scanningâ€¦';
  prog.style.display = 'block';
  res.style.display  = 'none';
  $('ocr-bar').style.width    = '2%';
  $('ocr-prog-txt').textContent = 'Loading OCR engineâ€¦';

  try {
    const worker = await Tesseract.createWorker('eng', 1, {
      logger: m => {
        if(m.status === 'recognizing text'){
          const pct = Math.round(m.progress * 100);
          $('ocr-bar').style.width    = pct + '%';
          $('ocr-prog-txt').textContent = `Recognising textâ€¦ ${pct}%`;
        } else {
          $('ocr-prog-txt').textContent = m.status;
        }
      }
    });

    $('ocr-bar').style.width = '15%';
    $('ocr-prog-txt').textContent = 'Analysing imageâ€¦';

    const { data: { text } } = await worker.recognize(b.screenshot_url);
    await worker.terminate();

    $('ocr-bar').style.width = '100%';
    $('ocr-prog-txt').textContent = 'âœ“ Done';

    const fullText    = (text || '').trim();
    const submittedUTR = (b.transaction_id || '').toUpperCase().trim();
    const detectedUTR  = extractUTR(fullText, submittedUTR);

    $('ocr-raw-text').textContent      = fullText || '(no text extracted â€” image may be too small or blurry)';
    $('ocr-submitted').textContent     = submittedUTR || 'â€”';
    $('ocr-detected').textContent      = detectedUTR  || 'Not found';

    // Verdict
    let verdictHtml = '';
    if(!fullText){
      verdictHtml = '<div class="match-pill mp-unknown">âš ï¸ No text detected â€” check image quality</div>';
    } else if(!detectedUTR){
      verdictHtml = '<div class="match-pill mp-partial">âš ï¸ UTR pattern not found in screenshot â€” verify manually</div>';
    } else if(detectedUTR === submittedUTR){
      verdictHtml = '<div class="match-pill mp-yes">âœ… EXACT MATCH â€” UTR confirmed in screenshot</div>';
    } else {
      const sim = strSimilarity(detectedUTR, submittedUTR);
      if(sim >= 0.85 || detectedUTR.includes(submittedUTR) || submittedUTR.includes(detectedUTR)){
        verdictHtml = `<div class="match-pill mp-partial">âš ï¸ PARTIAL MATCH (${Math.round(sim*100)}% similar) â€” Review carefully</div>
          <div style="font-size:.7rem;color:var(--ash);margin-top:4px">Detected: <strong style="color:var(--white)">${esc(detectedUTR)}</strong> Â· Submitted: <strong style="color:var(--white)">${esc(submittedUTR)}</strong></div>`;
      } else {
        verdictHtml = `<div class="match-pill mp-no">âŒ MISMATCH â€” Screenshot UTR does not match submitted UTR</div>
          <div style="font-size:.7rem;color:var(--ash);margin-top:4px">Detected: <strong style="color:var(--red)">${esc(detectedUTR)}</strong> Â· Submitted: <strong style="color:var(--white)">${esc(submittedUTR)}</strong></div>`;
      }
    }
    $('ocr-verdict').innerHTML = verdictHtml;
    res.style.display = 'block';

  } catch(e) {
    $('ocr-prog-txt').textContent = 'OCR failed: ' + e.message;
    $('ocr-bar').style.cssText   = 'width:100%;background:var(--red)';
    toast('OCR error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg> Re-scan';
  }
}

/* Extract the most likely UTR from OCR text */
function extractUTR(text, hint){
  const up = text.toUpperCase();
  // 1. Look for the submitted UTR directly in the text
  if(hint && up.includes(hint)) return hint;

  // 2. Context-aware: text near transaction keywords
  const ctx = up.match(/(?:UTR|REF(?:ERENCE)?|TXN|TRANSACTION[\s_]?ID|ORDER[\s_]?ID|PAYMENT[\s_]?ID)[:\s#\-]*([A-Z0-9]{10,25})/);
  if(ctx) return ctx[1];

  // 3. Pattern hierarchy
  const patterns = [
    /\b(T\d{10,14})\b/,            // Paytm
    /\b([A-Z]{3,5}\d{12,18})\b/,  // Bank NEFT (e.g. HDFC123456...)
    /\b(\d{12})\b/,                 // 12-digit IMPS/GPay
    /\b(\d{13,15})\b/,              // Extended numeric
    /\b([A-Z0-9]{16,22})\b/,       // Generic alphanum
  ];
  for(const p of patterns){
    const m = up.match(p);
    if(m) return m[1];
  }
  return null;
}

/* Levenshtein-based similarity 0-1 */
function strSimilarity(a, b){
  if(a === b) return 1;
  const la = a.length, lb = b.length;
  if(!la || !lb) return 0;
  const dp = Array.from({length:la+1}, (_,i) => Array.from({length:lb+1}, (_,j) => i ? j ? 0 : i : j));
  for(let i=1;i<=la;i++) for(let j=1;j<=lb;j++)
    dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
  return 1 - dp[la][lb] / Math.max(la, lb);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateStatus(id, status){
  try {
    const res = await fetch(`${SB}/rest/v1/ticket_bookings?id=eq.${id}`, {
      method: 'PATCH',
      headers: { ...hdrs(true), 'Prefer': 'return=minimal' },
      body: JSON.stringify({
        approval_status: status,
        approved_at:     new Date().toISOString(),
        approved_by:     $('admin-email').textContent,
      })
    });
    if(!res.ok) throw new Error('HTTP ' + res.status + ' â€” ' + await res.text());

    const idx = allBookings.findIndex(b => b.id === id);
    if(idx !== -1){
      allBookings[idx].approval_status = status;
      allBookings[idx].approved_at = new Date().toISOString();
    }
    updateStats();
    applyFilters();
    toast(status==='approved' ? 'âœ… Booking approved!' : 'âŒ Booking rejected.', status==='approved' ? 'success' : 'warn');
    if(modalBooking?.id === id) closeModal();
  } catch(e) {
    toast('Update failed: ' + e.message, 'error');
  }
}

async function modalAction(status){
  if(!modalBooking) return;
  await updateStatus(modalBooking.id, status);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE BOOKING (+ screenshot)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmDeleteBooking(id){
  const b = allBookings.find(x => x.id === id);
  showConfirm({
    icon: 'ğŸ—‘ï¸',
    title: 'Delete Booking',
    msg: `Delete booking <strong>${esc(b?.booking_id||id)}</strong> for <strong>${esc(b?.name||'?')}</strong>?<br>The payment screenshot will also be removed from storage.`,
    confirmLabel: 'ğŸ—‘ Delete',
    onConfirm: () => deleteBooking(id, b?.screenshot_url)
  });
}

function modalDelete(){
  if(!modalBooking) return;
  closeModal();
  confirmDeleteBooking(modalBooking.id);
}

async function deleteBooking(id, screenshotUrl){
  try {
    // Delete screenshot file from storage
    if(screenshotUrl){
      const path = screenshotUrl.split(`/storage/v1/object/public/${BUCKET}/`)[1];
      if(path){
        await fetch(`${SB}/storage/v1/object/${BUCKET}/${decodeURIComponent(path)}`, {
          method: 'DELETE',
          headers: hdrs(true)
        });
      }
    }
    // Delete database row
    const res = await fetch(`${SB}/rest/v1/ticket_bookings?id=eq.${id}`, {
      method: 'DELETE',
      headers: { ...hdrs(true), 'Prefer': 'return=minimal' }
    });
    if(!res.ok) throw new Error('HTTP ' + res.status + ' â€” ' + await res.text());

    allBookings = allBookings.filter(b => b.id !== id);
    updateStats();
    applyFilters();
    toast('Booking deleted successfully.', 'success');
  } catch(e) {
    toast('Delete failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLEAR ENTIRE DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmClearDB(){
  showConfirm({
    icon: 'ğŸ’£',
    title: 'Clear Entire Database',
    msg: 'This will <strong style="color:var(--red)">permanently delete ALL bookings and ALL payment screenshots</strong>.<br><br>Type <strong>DELETE ALL</strong> to confirm:',
    confirmLabel: 'ğŸ’£ Clear Everything',
    requireInput: 'DELETE ALL',
    onConfirm: clearDatabase
  });
}

async function clearDatabase(){
  toast('Clearing databaseâ€¦', 'info');
  try {
    // 1. Collect all screenshot paths
    const urls = allBookings.map(b => b.screenshot_url).filter(Boolean);
    let deletedFiles = 0;
    for(const url of urls){
      const path = url.split(`/storage/v1/object/public/${BUCKET}/`)[1];
      if(path){
        try{
          await fetch(`${SB}/storage/v1/object/${BUCKET}/${decodeURIComponent(path)}`,{
            method:'DELETE', headers: hdrs(true)
          });
          deletedFiles++;
        }catch{}
      }
    }

    // 2. Delete all rows (use neq on a non-existent id to delete all)
    const res = await fetch(`${SB}/rest/v1/ticket_bookings?approval_status=neq.XXXX_DUMMY_THAT_NEVER_EXISTS`, {
      method: 'DELETE',
      headers: { ...hdrs(true), 'Prefer': 'return=minimal' }
    });
    if(!res.ok){
      // Fallback: delete all row by row
      for(const b of allBookings){
        await fetch(`${SB}/rest/v1/ticket_bookings?id=eq.${b.id}`,{
          method:'DELETE', headers:{...hdrs(true),'Prefer':'return=minimal'}
        });
      }
    }

    allBookings = [];
    updateStats();
    applyFilters();
    toast(`âœ… Done. Deleted ${urls.length} booking(s) and ${deletedFiles} screenshot(s).`, 'success');
  } catch(e) {
    toast('Clear failed: ' + e.message, 'error');
    loadBookings();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIRM DIALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showConfirm({ icon, title, msg, confirmLabel, requireInput, onConfirm }){
  $('conf-icon').textContent   = icon   || 'âš ï¸';
  $('conf-title').textContent  = title  || 'Confirm?';
  $('conf-msg').innerHTML      = msg    || '';
  $('conf-ok').textContent     = confirmLabel || 'Confirm';

  const inp = $('conf-inp');
  confirmAction       = onConfirm;
  confirmRequireInput = requireInput || null;

  if(requireInput){
    inp.style.display = 'block';
    inp.placeholder   = requireInput;
    inp.value         = '';
    $('conf-ok').disabled = true;
    inp.oninput = () => { $('conf-ok').disabled = (inp.value.trim() !== requireInput); };
  } else {
    inp.style.display = 'none';
    $('conf-ok').disabled = false;
    inp.oninput = null;
  }

  $('conf-bg').classList.remove('hidden');
}

function executeConfirm(){
  closeConfirm();
  confirmAction?.();
}

function closeConfirm(){
  $('conf-bg').classList.add('hidden');
  confirmAction = null;
}

$('conf-bg').addEventListener('click', e => { if(e.target === $('conf-bg')) closeConfirm(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(() => { if(authToken) loadBookings(); }, 45_000);
</script>
</body>
</html>
