<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¬ Admin Dashboard â€” Movie Time Festival 2026</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --void:#050507; --ink:#0d0d12; --charcoal:#141419; --carbon:#1c1c24;
  --graphite:#252530; --steel:#34343f; --iron:#4a4a58; --ash:#6b6b7e;
  --silver:#a0a0b8; --mist:#c8c8dc; --ghost:#e8e8f0; --white:#f8f8ff;
  --flame:#ff6b00; --amber:#ff8c42; --gold:#ffb347;
  --green:#00e676; --red:#ff1744; --yellow:#ffd600; --blue:#00b0ff;
  --r:12px; --r-sm:8px;
  --font:'Syne',sans-serif; --mono:'DM Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--void);color:var(--ghost);min-height:100vh}
.hidden{display:none!important}

/* LAYOUT */
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
@media(max-width:768px){.layout{grid-template-columns:1fr}.sidebar{display:none}}

/* SIDEBAR */
.sidebar{background:var(--ink);border-right:1px solid var(--graphite);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}
.sidebar-logo{padding:1.5rem;border-bottom:1px solid var(--graphite)}
.sidebar-logo h2{font-size:1.1rem;font-weight:800;background:linear-gradient(135deg,var(--amber),var(--flame));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.sidebar-logo p{font-size:.68rem;color:var(--ash);margin-top:2px;letter-spacing:.1em;text-transform:uppercase}
.sidebar-nav{padding:1rem .75rem;flex:1}
.nav-sep{font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--iron);padding:10px 12px 4px;margin-top:6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r-sm);color:var(--ash);font-size:.88rem;font-weight:600;cursor:pointer;margin-bottom:4px;transition:all .2s;border:1px solid transparent}
.nav-item:hover{background:var(--carbon);color:var(--mist)}
.nav-item.active{background:rgba(255,107,0,.12);color:var(--amber);border-color:rgba(255,107,0,.2)}
.nav-badge{margin-left:auto;background:var(--flame);color:#000;border-radius:50px;padding:2px 8px;font-size:.68rem;font-weight:800}
.sidebar-footer{padding:1rem;border-top:1px solid var(--graphite)}

/* TOPBAR */
.admin-main{background:var(--void);overflow-x:hidden}
.topbar{background:var(--ink);border-bottom:1px solid var(--graphite);padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;position:sticky;top:0;z-index:100}
.topbar h1{font-size:1.1rem;font-weight:700;color:var(--white)}
.topbar-right{display:flex;align-items:center;gap:10px}
.admin-badge{background:rgba(255,107,0,.15);border:1px solid rgba(255,107,0,.3);border-radius:50px;padding:4px 14px;font-size:.72rem;font-weight:700;color:var(--amber)}
.refresh-btn{background:var(--graphite);border:1px solid var(--steel);border-radius:var(--r-sm);padding:6px 14px;color:var(--silver);font-family:var(--font);font-size:.8rem;font-weight:600;cursor:pointer}
.refresh-btn:hover{background:var(--steel)}

/* CONTENT / PAGES */
.content{padding:1.5rem}
.page{display:none}.page.active{display:block}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(148px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r);padding:1.25rem}
.highlight-card{background:var(--charcoal);border:1px solid rgba(255,107,0,.3);box-shadow:0 0 24px rgba(255,107,0,.07)}
.stat-label{font-size:.72rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin-bottom:8px}
.stat-value{font-size:2rem;font-weight:800}
.v-orange{color:var(--amber)}.v-green{color:var(--green)}.v-red{color:var(--red)}.v-yellow{color:var(--yellow)}
.stat-sub{font-size:.78rem;color:var(--ash);margin-top:4px}

/* FILTERS */
.filters{display:flex;gap:10px;margin-bottom:1.25rem;flex-wrap:wrap;align-items:center}
.filter-btn{padding:8px 16px;border-radius:50px;font-family:var(--font);font-size:.8rem;font-weight:700;cursor:pointer;border:1px solid var(--steel);background:transparent;color:var(--ash);transition:all .18s}
.filter-btn:hover{background:var(--graphite);color:var(--mist)}
.filter-btn.active{background:rgba(255,107,0,.15);border-color:rgba(255,107,0,.4);color:var(--amber)}
.search-input{flex:1;min-width:200px;background:var(--carbon);border:1px solid var(--steel);border-radius:var(--r-sm);padding:8px 14px;color:var(--white);font-family:var(--font);font-size:.85rem}
.search-input:focus{outline:none;border-color:var(--flame)}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:var(--r);border:1px solid var(--graphite)}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead{background:var(--charcoal);border-bottom:1px solid var(--graphite)}
th{padding:12px 14px;text-align:left;font-weight:700;font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--graphite);transition:background .15s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.025)}
td{padding:11px 14px;vertical-align:middle}
.mono{font-family:var(--mono);font-size:.78rem}
.name-cell{font-weight:600;color:var(--white)}
.email-cell{color:var(--silver);font-size:.8rem}

.status-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:50px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em}
.pill-pending{background:rgba(255,214,0,.1);color:var(--yellow);border:1px solid rgba(255,214,0,.25)}
.pill-approved{background:rgba(0,230,118,.1);color:var(--green);border:1px solid rgba(0,230,118,.25)}
.pill-rejected{background:rgba(255,23,68,.1);color:var(--red);border:1px solid rgba(255,23,68,.25)}

.action-wrap{display:flex;gap:5px;flex-wrap:wrap}
.action-btn{padding:5px 10px;border-radius:6px;font-family:var(--font);font-size:.72rem;font-weight:700;cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.approve-btn{background:rgba(0,230,118,.15);color:var(--green);border:1px solid rgba(0,230,118,.3)}
.approve-btn:hover{background:rgba(0,230,118,.25)}
.approve-btn:disabled{opacity:.4;cursor:not-allowed}
.reject-btn{background:rgba(255,23,68,.12);color:var(--red);border:1px solid rgba(255,23,68,.25)}
.reject-btn:hover{background:rgba(255,23,68,.22)}
.view-btn{background:var(--graphite);color:var(--silver);border:1px solid var(--steel)}
.view-btn:hover{background:var(--steel)}
.ss-btn{background:rgba(0,176,255,.1);color:var(--blue);border:1px solid rgba(0,176,255,.25)}
.ss-btn:hover{background:rgba(0,176,255,.2)}
.cmp-btn{background:rgba(255,107,0,.1);color:var(--amber);border:1px solid rgba(255,107,0,.25)}
.cmp-btn:hover{background:rgba(255,107,0,.2)}
.cmp-btn.selected{background:rgba(255,107,0,.3);border-color:var(--flame);color:var(--flame)}
.del-btn{background:rgba(255,23,68,.1);color:var(--red);border:1px solid rgba(255,23,68,.25)}
.del-btn:hover{background:rgba(255,23,68,.22)}
.danger-btn{background:rgba(255,23,68,.18);color:var(--red);border:1px solid rgba(255,23,68,.4)!important}
.danger-btn:hover{background:rgba(255,23,68,.3)}

/* BULK BAR */
.bulk-bar{background:var(--ink);border:1px solid rgba(255,23,68,.25);border-radius:var(--r);padding:.85rem 1.25rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.bulk-label{font-size:.8rem;font-weight:700;color:var(--red);white-space:nowrap}
.bulk-count{font-size:.8rem;color:var(--silver);flex:1}
.bulk-actions{display:flex;gap:8px}
input[type=checkbox]{accent-color:var(--flame);width:15px;height:15px;cursor:pointer;vertical-align:middle}
th.cb-col,td.cb-col{width:36px;padding-left:14px;padding-right:4px}

/* CONFIRM MODAL */
.confirm-modal{max-width:420px}
.confirm-body{padding:2rem 1.5rem;text-align:center}
.confirm-icon{font-size:3rem;margin-bottom:.75rem}
.confirm-body h4{font-size:1.1rem;font-weight:800;color:var(--white);margin-bottom:.6rem}
.confirm-body p{font-size:.85rem;color:var(--ash);line-height:1.6}
.confirm-highlight{color:var(--red);font-weight:700}
.confirm-actions{padding:1rem 1.5rem;border-top:1px solid var(--graphite);display:flex;gap:10px}
.confirm-actions .action-btn{flex:1;padding:12px;font-size:.88rem}

/* COMPARE BAR */
.compare-bar{background:var(--ink);border:1px solid rgba(255,107,0,.25);border-radius:var(--r);padding:1rem 1.25rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.cbar-label{font-size:.8rem;font-weight:700;color:var(--amber);white-space:nowrap}
.cbar-tags{display:flex;gap:8px;flex:1;flex-wrap:wrap}
.cbar-tag{background:rgba(255,107,0,.12);border:1px solid rgba(255,107,0,.25);border-radius:50px;padding:3px 12px;font-size:.76rem;color:var(--amber);font-weight:600}
.cbar-actions{display:flex;gap:8px}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:800;display:flex;align-items:center;justify-content:center;padding:1rem}
.modal{background:var(--carbon);border:1px solid var(--graphite);border-radius:20px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto}
.modal-wide{max-width:880px}
.modal-head{padding:1.5rem;border-bottom:1px solid var(--graphite);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--carbon);z-index:1}
.modal-head h3{font-size:1.05rem;font-weight:700}
.modal-close{background:var(--graphite);border:none;color:var(--silver);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.modal-close:hover{background:var(--steel)}
.modal-body{padding:1.5rem}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.detail-item label{display:block;font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin-bottom:4px}
.detail-item span{font-size:.87rem;color:var(--white);word-break:break-all}
.detail-item.wide{grid-column:1/-1}
.modal-actions{padding:1rem 1.5rem;border-top:1px solid var(--graphite);display:flex;gap:10px;flex-wrap:wrap}
.modal-actions .action-btn{flex:1;padding:10px;font-size:.82rem}

/* SCREENSHOT PREVIEW IN MODAL */
.ss-preview-wrap{margin-top:1.25rem;border-top:1px solid var(--graphite);padding-top:1.25rem}
.ss-preview-label{font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin-bottom:8px}
.ss-preview-img{width:100%;border-radius:var(--r-sm);border:1px solid var(--steel);cursor:pointer;transition:border-color .2s}
.ss-preview-img:hover{border-color:var(--flame)}
.ss-preview-hint{font-size:.72rem;color:var(--ash);margin-top:6px;text-align:center}

/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:1200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem;overflow:auto}
.lb-close-btn{position:fixed;top:1rem;right:1rem;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;width:42px;height:42px;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1201}
.lb-close-btn:hover{background:rgba(255,255,255,.2)}
#lb-img{max-width:88vw;max-height:78vh;border-radius:var(--r);border:1px solid var(--steel);object-fit:contain;cursor:zoom-in;transition:transform .2s}
#lb-img.zoomed{max-width:none;max-height:none;cursor:zoom-out}
.lb-info{color:var(--ash);font-size:.78rem;margin-top:.75rem;text-align:center}
.lb-bar{display:flex;gap:10px;margin-top:.75rem}
.lb-btn{background:var(--graphite);border:1px solid var(--steel);color:var(--silver);padding:8px 16px;border-radius:var(--r-sm);font-family:var(--font);font-size:.8rem;font-weight:600;cursor:pointer}
.lb-btn:hover{background:var(--steel)}
.lb-btn.blue{background:rgba(0,176,255,.12);color:var(--blue);border-color:rgba(0,176,255,.3)}

/* COMPARE MODAL */
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem}
@media(max-width:640px){.compare-grid{grid-template-columns:1fr}}
.cmp-col{background:var(--charcoal);border:1px solid var(--graphite);border-radius:var(--r);padding:1.25rem}
.cmp-col-title{font-size:.72rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--amber);margin-bottom:1rem;padding-bottom:.6rem;border-bottom:1px solid var(--graphite)}
.cmp-field{margin-bottom:.75rem}
.cmp-field label{display:block;font-size:.62rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ash);margin-bottom:2px}
.cmp-field span{font-size:.84rem;color:var(--white);word-break:break-all}
.cmp-field.diff span{color:var(--yellow)}
.cmp-field.diff label::after{content:" âš ";color:var(--yellow)}
.cmp-ss{width:100%;border-radius:var(--r-sm);margin-top:.75rem;border:1px solid var(--steel);cursor:pointer}
.cmp-ss:hover{border-color:var(--flame)}
.cmp-no-ss{font-size:.78rem;color:var(--iron);font-style:italic;margin-top:.75rem}

/* VERIFY PAGE */
.verify-wrap{max-width:560px;margin:0 auto;padding-top:.25rem}
.verify-search-box{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r);padding:1.5rem;margin-bottom:1.5rem}
.verify-search-box h3{font-size:1rem;font-weight:700;color:var(--white);margin-bottom:.4rem}
.verify-search-box p{font-size:.82rem;color:var(--ash);margin-bottom:1rem}
.verify-row{display:flex;gap:10px}
.verify-input{flex:1;background:var(--graphite);border:2px solid var(--steel);border-radius:var(--r-sm);padding:11px 14px;color:var(--white);font-family:var(--mono);font-size:.9rem}
.verify-input:focus{outline:none;border-color:var(--flame)}
.verify-btn{background:linear-gradient(135deg,var(--flame),#e63900);color:#fff;border:none;border-radius:var(--r-sm);padding:11px 22px;font-family:var(--font);font-size:.9rem;font-weight:700;cursor:pointer}
.verify-btn:hover{opacity:.9}
.verify-result{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r);padding:1.5rem}
.v-banner{border-radius:var(--r-sm);padding:1rem 1.25rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:14px}
.v-banner.approved{background:rgba(0,230,118,.1);border:1px solid rgba(0,230,118,.3)}
.v-banner.pending{background:rgba(255,214,0,.1);border:1px solid rgba(255,214,0,.3)}
.v-banner.rejected{background:rgba(255,23,68,.1);border:1px solid rgba(255,23,68,.25)}
.v-banner.notfound{background:rgba(255,23,68,.07);border:1px solid rgba(255,23,68,.2)}
.v-banner-icon{font-size:2.2rem;line-height:1}
.v-banner-text h4{font-size:1.05rem;font-weight:800;margin-bottom:2px}
.v-banner.approved .v-banner-text h4{color:var(--green)}
.v-banner.pending  .v-banner-text h4{color:var(--yellow)}
.v-banner.rejected .v-banner-text h4, .v-banner.notfound .v-banner-text h4{color:var(--red)}
.v-banner-text p{font-size:.8rem;color:var(--ash)}
.v-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
.v-field label{display:block;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin-bottom:3px}
.v-field span{font-size:.85rem;color:var(--white)}
.v-ss{width:100%;border-radius:var(--r-sm);margin-top:1rem;border:1px solid var(--steel);cursor:pointer}
.v-ss:hover{border-color:var(--flame)}
.v-actions{display:flex;gap:10px;margin-top:1rem}
.v-actions .action-btn{flex:1;padding:12px;font-size:.85rem}

/* SCREENSHOT GALLERY */
.ss-gallery-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
.ss-gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.ss-card{background:var(--carbon);border:1px solid var(--graphite);border-radius:var(--r);overflow:hidden;transition:border-color .2s,transform .15s;cursor:pointer}
.ss-card:hover{border-color:var(--flame);transform:translateY(-2px)}
.ss-card-img-wrap{width:100%;aspect-ratio:4/3;background:var(--charcoal);overflow:hidden;position:relative}
.ss-card-img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity .2s}
.ss-card-img.loading-img{opacity:.4}
.ss-card-no-img{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--iron)}
.ss-card-badge{position:absolute;top:8px;right:8px;font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:50px}
.ss-card-body{padding:.85rem}
.ss-card-name{font-size:.78rem;font-weight:700;color:var(--white);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ss-card-meta{font-size:.7rem;color:var(--ash)}
.ss-card-booking{font-size:.7rem;color:var(--blue);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.ss-card-booking:hover{text-decoration:underline}
.ss-card-unlinked{font-size:.7rem;color:var(--iron);margin-top:4px;font-style:italic}
.ss-card-actions{display:flex;gap:6px;margin-top:.75rem}

/* EMPTY / LOADING */
.empty{text-align:center;padding:3rem 1rem;color:var(--ash)}
.empty-icon{font-size:3rem;margin-bottom:1rem}
.empty-text{font-size:.9rem}
.loading{text-align:center;padding:2rem;color:var(--ash);font-size:.88rem}
.spin{display:inline-block;width:18px;height:18px;border:2px solid var(--steel);border-top-color:var(--flame);border-radius:50%;animation:rot .65s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes rot{to{transform:rotate(360deg)}}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--green);color:#000;padding:8px 20px;border-radius:50px;font-size:.82rem;font-weight:700;z-index:9999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.error{background:var(--red);color:#fff}
</style>
</head>
<body>

<div class="layout" id="app">

  <!-- â•â•â• SIDEBAR â•â•â• -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h2>ğŸ¬ MOVIE TIME</h2>
      <p>Admin Dashboard Â· 2026</p>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-sep">Bookings</div>
      <div class="nav-item active" id="nav-bookings" onclick="showPage('bookings',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        All Bookings
        <span class="nav-badge" id="pending-count">0</span>
      </div>
      <div class="nav-item" id="nav-approved" onclick="showPage('approved',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Approved
      </div>
      <div class="nav-item" id="nav-rejected" onclick="showPage('rejected',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        Rejected
      </div>
      <div class="nav-sep">Tools</div>
      <div class="nav-item" id="nav-screenshots" onclick="showPage('screenshots',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        Screenshots
        <span class="nav-badge" id="ss-count" style="background:var(--blue);color:#000">0</span>
      </div>
      <div class="nav-item" id="nav-verify" onclick="showPage('verify',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Ticket Verify
      </div>
    </nav>
    <div class="sidebar-footer">
      <div style="font-size:.72rem;color:var(--iron)">Movie Time Festival 2026</div>
      <div style="font-size:.82rem;color:var(--silver);margin-top:2px">Admin Panel</div>
    </div>
  </aside>

  <!-- â•â•â• MAIN â•â•â• -->
  <div class="admin-main">
    <div class="topbar">
      <h1 id="view-title">All Bookings</h1>
      <div class="topbar-right">
        <span class="admin-badge">Admin</span>
        <button class="refresh-btn" onclick="loadBookings()">â†» Refresh</button>
      </div>
    </div>

    <div class="content">

      <!-- PAGE: ALL BOOKINGS -->
      <div class="page active" id="page-bookings">
        <div class="stats-grid">
          <div class="stat-card highlight-card">
            <div class="stat-label">ğŸ’° Ticket Income</div>
            <div class="stat-value v-green" id="st-revenue">â‚¹0</div>
            <div class="stat-sub">Approved only</div>
          </div>
          <div class="stat-card highlight-card">
            <div class="stat-label">ğŸŸï¸ No. of Sells</div>
            <div class="stat-value v-orange" id="st-sells">0</div>
            <div class="stat-sub">Tickets sold</div>
          </div>
          <div class="stat-card"><div class="stat-label">Total Bookings</div><div class="stat-value v-orange" id="st-total">â€”</div></div>
          <div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value v-yellow" id="st-pending">â€”</div></div>
          <div class="stat-card"><div class="stat-label">Approved</div><div class="stat-value v-green" id="st-approved">â€”</div></div>
          <div class="stat-card"><div class="stat-label">Rejected</div><div class="stat-value v-red" id="st-rejected">â€”</div></div>
        </div>

        <!-- COMPARE BAR (hidden until 1 booking selected) -->
        <div class="compare-bar hidden" id="compare-bar">
          <span class="cbar-label">âš–ï¸ Compare:</span>
          <div class="cbar-tags" id="cbar-tags"></div>
          <div class="cbar-actions">
            <button class="action-btn approve-btn" id="cmp-go-btn" onclick="openCompareModal()" disabled>Select 1 more â†’</button>
            <button class="action-btn view-btn" onclick="clearCompare()">âœ• Clear</button>
          </div>
        </div>

        <!-- BULK DELETE BAR (hidden until rows checked) -->
        <div class="bulk-bar hidden" id="bulk-bar">
          <span class="bulk-label">ğŸ—‘ï¸ Delete Mode</span>
          <span class="bulk-count" id="bulk-count">0 selected</span>
          <div class="bulk-actions">
            <button class="action-btn danger-btn" id="bulk-del-btn" onclick="confirmBulkDelete()">ğŸ—‘ï¸ Delete Selected</button>
            <button class="action-btn view-btn" onclick="clearBulkSelect()">âœ• Cancel</button>
          </div>
        </div>

        <div class="filters">
          <button class="filter-btn active" id="fb-all"      onclick="setFilter('all')">All</button>
          <button class="filter-btn"        id="fb-pending"  onclick="setFilter('pending')">â³ Pending</button>
          <button class="filter-btn"        id="fb-approved" onclick="setFilter('approved')">âœ… Approved</button>
          <button class="filter-btn"        id="fb-rejected" onclick="setFilter('rejected')">âŒ Rejected</button>
          <input class="search-input" type="text" id="search-inp" placeholder="Search name, email, booking ID, UTRâ€¦" oninput="applySearch(this.value)">
          <button class="refresh-btn danger-btn" onclick="confirmClearAll()" title="Delete all visible bookings">ğŸ—‘ï¸ Clear All</button>
        </div>
        <div id="table-area"><div class="loading"><span class="spin"></span> Loading bookingsâ€¦</div></div>
      </div>

      <!-- PAGE: APPROVED -->
      <div class="page" id="page-approved">
        <div id="table-area-approved"><div class="loading"><span class="spin"></span> Loadingâ€¦</div></div>
      </div>

      <!-- PAGE: REJECTED -->
      <div class="page" id="page-rejected">
        <div id="table-area-rejected"><div class="loading"><span class="spin"></span> Loadingâ€¦</div></div>
      </div>

      <!-- PAGE: SCREENSHOTS -->
      <div class="page" id="page-screenshots">
        <div class="ss-gallery-toolbar">
          <span id="ss-gallery-count" style="font-size:.82rem;color:var(--ash)">Loadingâ€¦</span>
          <button class="refresh-btn" onclick="loadScreenshots()">â†» Refresh</button>
        </div>
        <div id="ss-gallery-area">
          <div class="loading"><span class="spin"></span> Loading screenshotsâ€¦</div>
        </div>
      </div>

      <!-- PAGE: TICKET VERIFY -->
      <div class="page" id="page-verify">
        <div class="verify-wrap">
          <div class="verify-search-box">
            <h3>ğŸ” Ticket Verifier</h3>
            <p>Enter a Booking ID or UTR / Transaction ID to verify a ticket instantly.</p>
            <div class="verify-row">
              <input class="verify-input" type="text" id="verify-input" placeholder="Booking ID or UTR numberâ€¦" onkeydown="if(event.key==='Enter')doVerify()">
              <button class="verify-btn" onclick="doVerify()">Verify</button>
            </div>
          </div>
          <div class="verify-result hidden" id="verify-result"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â• BOOKING DETAIL MODAL â•â•â• -->
<div class="modal-overlay hidden" id="detail-modal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-title">Booking Details</h3>
      <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="modal-details"></div>
      <div class="ss-preview-wrap hidden" id="modal-ss-wrap">
        <div class="ss-preview-label">Payment Screenshot</div>
        <img id="modal-ss-img" class="ss-preview-img" src="" onclick="openLightbox(this.src)" alt="Screenshot">
        <div class="ss-preview-hint">
          Click image to enlarge &nbsp;Â·&nbsp;
          <a id="modal-ss-link" href="#" target="_blank" style="color:var(--blue)">Open original â†—</a>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="action-btn approve-btn" id="modal-approve-btn" onclick="modalAction('approved')">âœ… Approve</button>
      <button class="action-btn reject-btn"  id="modal-reject-btn"  onclick="modalAction('rejected')">âŒ Reject</button>
      <button class="action-btn ss-btn"      id="modal-ss-open-btn" onclick="openLightbox(document.getElementById('modal-ss-img').src)">ğŸ–¼ Full Screenshot</button>
      <button class="action-btn del-btn"     id="modal-del-btn"     onclick="deleteFromModal()">ğŸ—‘ï¸ Delete</button>
      <button class="action-btn view-btn"    onclick="closeDetailModal()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â• SCREENSHOT LIGHTBOX â•â•â• -->
<div id="lightbox" class="hidden">
  <button class="lb-close-btn" onclick="closeLightbox()">âœ•</button>
  <img id="lb-img" src="" alt="Payment Screenshot" onclick="toggleLbZoom()">
  <div class="lb-info" id="lb-info">Click image to zoom</div>
  <div class="lb-bar">
    <button class="lb-btn blue" onclick="window.open(document.getElementById('lb-img').src,'_blank')">â†— Open Original</button>
    <button class="lb-btn" onclick="toggleLbZoom()">ğŸ” Toggle Zoom</button>
    <button class="lb-btn" onclick="closeLightbox()">Close</button>
  </div>
</div>

<!-- â•â•â• COMPARE MODAL â•â•â• -->
<div class="modal-overlay hidden" id="compare-modal">
  <div class="modal modal-wide">
    <div class="modal-head">
      <h3>âš–ï¸ Side-by-Side Comparison</h3>
      <button class="modal-close" onclick="closeCompareModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="compare-grid" id="compare-grid"></div>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIRM DELETE MODAL â•â•â• -->
<div class="modal-overlay hidden" id="confirm-modal">
  <div class="modal confirm-modal">
    <div class="confirm-body">
      <div class="confirm-icon">ğŸ—‘ï¸</div>
      <h4 id="confirm-title">Delete Booking?</h4>
      <p id="confirm-msg">This action cannot be undone.</p>
    </div>
    <div class="confirm-actions">
      <button class="action-btn danger-btn" id="confirm-ok-btn" onclick="confirmOk()">Yes, Delete</button>
      <button class="action-btn view-btn" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://vjxidlnggrpbttxmrfch.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqeGlkbG5nZ3JwYnR0eG1yZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjQ2MzYsImV4cCI6MjA4NzAwMDYzNn0.G7OXaE8hi-1ELJAmw_-gLi658henIj2NjIBqFd3HWWo';
const H = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY };
const BUCKET      = 'payment-screenshots';
const PUBLIC_BASE = `${SB_URL}/storage/v1/object/public/${BUCKET}/`;

function ssUrl(raw) {
  if (!raw) return null;
  if (raw.startsWith('http')) return raw;
  const clean = raw.replace(new RegExp('^' + BUCKET + '/?'), '').replace(/^//, '');
  return PUBLIC_BASE + clean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allBookings  = [];
let filteredBkgs = [];
let curFilter    = 'all';
let curSearch    = '';
let curPage      = 'bookings';
let activeModal  = null;   // the booking shown in detail modal
let compareList  = [];     // max 2 booking ids

// Boot
loadBookings();
loadScreenshotCount();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load screenshot count for sidebar badge
async function loadScreenshotCount() {
  try {
    const res = await fetch(`${SB_URL}/storage/v1/object/list/${BUCKET}`, {
      method: 'POST',
      headers: { ...H, 'Content-Type': 'application/json' },
      body: JSON.stringify({ limit: 200, offset: 0 })
    });
    if (!res.ok) return;
    const files = await res.json();
    document.getElementById('ss-count').textContent = files.length;
  } catch(_) {}
}

//  PAGE NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(page, el) {
  curPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  el.classList.add('active');
  const titles = {bookings:'All Bookings',approved:'Approved Bookings',rejected:'Rejected Bookings',screenshots:'ğŸ–¼ï¸ Screenshots',verify:'ğŸ” Ticket Verifier'};
  document.getElementById('view-title').textContent = titles[page] || page;
  if (page === 'approved')    renderSubTable('approved');
  if (page === 'rejected')    renderSubTable('rejected');
  if (page === 'screenshots') loadScreenshots();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBookings() {
  document.getElementById('table-area').innerHTML =
    '<div class="loading"><span class="spin"></span> Loading bookingsâ€¦</div>';
  try {
    const res = await fetch(
      `${SB_URL}/rest/v1/ticket_bookings?select=*&order=submitted_at.desc`, { headers: H }
    );
    if (!res.ok) throw new Error('HTTP ' + res.status);
    allBookings = await res.json();
    updateStats();
    applyFilters();
    if (curPage === 'approved') renderSubTable('approved');
    if (curPage === 'rejected') renderSubTable('rejected');
  } catch(e) {
    document.getElementById('table-area').innerHTML =
      `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-text">${e.message}</div></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENSHOTS GALLERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScreenshots() {
  const area = document.getElementById('ss-gallery-area');
  const countEl = document.getElementById('ss-gallery-count');
  area.innerHTML = '<div class="loading"><span class="spin"></span> Loading screenshotsâ€¦</div>';

  try {
    // Fetch all files from the bucket
    const res = await fetch(`${SB_URL}/storage/v1/object/list/${BUCKET}`, {
      method: 'POST',
      headers: { ...H, 'Content-Type': 'application/json' },
      body: JSON.stringify({ limit: 200, offset: 0, sortBy: { column: 'created_at', order: 'desc' } })
    });
    if (!res.ok) throw new Error('Storage fetch failed: ' + res.status);
    const files = await res.json();

    // Update count badge
    document.getElementById('ss-count').textContent = files.length;
    countEl.textContent = `${files.length} screenshot${files.length !== 1 ? 's' : ''} uploaded by users`;

    if (!files.length) {
      area.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ–¼ï¸</div><div class="empty-text">No screenshots uploaded yet.</div></div>';
      return;
    }

    renderGallery(files);
  } catch(e) {
    area.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-text">${e.message}</div></div>`;
  }
}

function renderGallery(files) {
  const area = document.getElementById('ss-gallery-area');

  const cards = files.map(file => {
    const url  = PUBLIC_BASE + encodeURIComponent(file.name);
    const size = file.metadata?.size ? formatBytes(file.metadata.size) : '';
    const date = file.created_at ? new Date(file.created_at).toLocaleString('en-IN', {dateStyle:'short', timeStyle:'short'}) : '';

    // Try to match to a booking via screenshot_url
    const linked = allBookings.find(b => {
      const u = ssUrl(b.screenshot_url);
      return u && (u.includes(file.name) || u.endsWith(encodeURIComponent(file.name)));
    });

    const statusColor = linked
      ? { approved: 'var(--green)', pending: 'var(--yellow)', rejected: 'var(--red)' }[linked.approval_status] || 'var(--ash)'
      : 'var(--iron)';

    const badgeStyle = linked
      ? `background:${statusColor};color:#000;opacity:.85`
      : 'background:var(--iron);color:#000;opacity:.6';

    return `<div class="ss-card" onclick="openLightbox('${url}', '${X(file.name)}')">
      <div class="ss-card-img-wrap">
        <img class="ss-card-img loading-img" src="${url}"
          onload="this.classList.remove('loading-img')"
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"
          alt="${X(file.name)}">
        <div class="ss-card-no-img" style="display:none">ğŸ–¼ï¸</div>
        ${linked ? `<span class="ss-card-badge" style="${badgeStyle}">${linked.approval_status}</span>` : ''}
      </div>
      <div class="ss-card-body">
        <div class="ss-card-name" title="${X(file.name)}">${X(file.name)}</div>
        <div class="ss-card-meta">${[size, date].filter(Boolean).join(' Â· ')}</div>
        ${linked
          ? `<div class="ss-card-booking" onclick="event.stopPropagation();openDetailModal('${linked.id}')">
               ğŸ”— ${X(linked.booking_id || linked.name || 'Booking')}
             </div>`
          : `<div class="ss-card-unlinked">Not linked to a booking</div>`
        }
        <div class="ss-card-actions">
          <button class="action-btn ss-btn" style="flex:1" onclick="event.stopPropagation();openLightbox('${url}','${X(file.name)}')">ğŸ” Enlarge</button>
          <button class="action-btn view-btn" onclick="event.stopPropagation();window.open('${url}','_blank')">â†—</button>
          ${linked ? `<button class="action-btn view-btn" onclick="event.stopPropagation();openDetailModal('${linked.id}')">ğŸ“‹ Booking</button>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  area.innerHTML = `<div class="ss-gallery-grid">${cards}</div>`;
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const approved = allBookings.filter(b => b.approval_status === 'approved');
  document.getElementById('st-total').textContent    = allBookings.length;
  document.getElementById('st-pending').textContent  = allBookings.filter(b => b.approval_status === 'pending').length;
  document.getElementById('st-approved').textContent = approved.length;
  document.getElementById('st-rejected').textContent = allBookings.filter(b => b.approval_status === 'rejected').length;
  document.getElementById('st-sells').textContent    = approved.reduce((s,b)=>s+(b.quantity||0),0);
  document.getElementById('st-revenue').textContent  = 'â‚¹' + approved.reduce((s,b)=>s+(b.total_amount||0),0).toLocaleString('en-IN');
  document.getElementById('pending-count').textContent = allBookings.filter(b=>b.approval_status==='pending').length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER & SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f) {
  curFilter = f;
  ['all','pending','approved','rejected'].forEach(x =>
    document.getElementById('fb-'+x)?.classList.toggle('active', x === f)
  );
  applyFilters();
}
function applySearch(v) { curSearch = v.toLowerCase(); applyFilters(); }
function applyFilters() {
  filteredBkgs = allBookings.filter(b => {
    if (curFilter !== 'all' && b.approval_status !== curFilter) return false;
    if (curSearch) {
      const h = [b.name,b.email,b.booking_id,b.transaction_id,b.phone].join(' ').toLowerCase();
      if (!h.includes(curSearch)) return false;
    }
    return true;
  });
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  document.getElementById('table-area').innerHTML = filteredBkgs.length
    ? buildTableHTML(filteredBkgs)
    : '<div class="empty"><div class="empty-icon">ğŸŸï¸</div><div class="empty-text">No bookings found.</div></div>';
}
function renderSubTable(status) {
  const rows = allBookings.filter(b => b.approval_status === status);
  document.getElementById('table-area-' + status).innerHTML = rows.length
    ? buildTableHTML(rows)
    : `<div class="empty"><div class="empty-icon">${status==='approved'?'âœ…':'âŒ'}</div><div class="empty-text">No ${status} bookings.</div></div>`;
}

function buildTableHTML(rows) {
  return `<div class="table-wrap"><table>
    <thead><tr>
      <th class="cb-col"><input type="checkbox" id="chk-all" onchange="toggleSelectAll(this)" title="Select all"></th>
      <th>#</th><th>Booking ID</th><th>Name</th><th>Email</th>
      <th>Phone</th><th>Qty</th><th>Amount</th><th>UTR</th>
      <th>Date</th><th>Status</th><th>Actions</th>
    </tr></thead>
    <tbody>${rows.map((b,i) => buildRowHTML(b,i+1)).join('')}</tbody>
  </table></div>`;
}

function buildRowHTML(b, idx) {
  const dt  = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'short'}) : 'â€”';
  const pnd = b.approval_status === 'pending';
  const sel = compareList.includes(b.id);
  const ss  = !!ssUrl(b.screenshot_url);
  const chk = bulkSelected.has(b.id);
  return `<tr id="row-${b.id}" ${chk ? 'style="background:rgba(255,23,68,.05)"' : ''}>
    <td class="cb-col"><input type="checkbox" class="row-chk" data-id="${b.id}" ${chk?'checked':''} onchange="toggleRowSelect(this)"></td>
    <td style="color:var(--ash)">${idx}</td>
    <td><span class="mono">${b.booking_id||'â€”'}</span></td>
    <td class="name-cell">${X(b.name||'â€”')}</td>
    <td class="email-cell">${X(b.email||'â€”')}</td>
    <td class="mono">${b.phone||'â€”'}</td>
    <td style="text-align:center;font-weight:700">${b.quantity||'â€”'}</td>
    <td style="color:var(--amber);font-weight:700">â‚¹${b.total_amount||'â€”'}</td>
    <td><span class="mono">${b.transaction_id||'â€”'}</span></td>
    <td style="color:var(--ash);font-size:.76rem">${dt}</td>
    <td>${pill(b.approval_status)}</td>
    <td>
      <div class="action-wrap">
        <button class="action-btn view-btn" onclick="openDetailModal('${b.id}')">ğŸ‘ï¸</button>
        ${ss ? `<button class="action-btn ss-btn" title="View Screenshot" onclick="openLightbox('${ssUrl(b.screenshot_url)}','${X(b.name||'')}')">ğŸ–¼</button>` : ''}
        <button class="action-btn cmp-btn ${sel?'selected':''}" title="Add to Compare" onclick="toggleCompare('${b.id}')">âš–ï¸</button>
        ${pnd ? `
          <button class="action-btn approve-btn" onclick="updateStatus('${b.id}','approved')">âœ…</button>
          <button class="action-btn reject-btn"  onclick="updateStatus('${b.id}','rejected')">âŒ</button>
        ` : ''}
        <button class="action-btn del-btn" title="Delete booking" onclick="confirmSingleDelete('${b.id}')">ğŸ—‘ï¸</button>
      </div>
    </td>
  </tr>`;
}

function pill(s) {
  const c={pending:'pill-pending',approved:'pill-approved',rejected:'pill-rejected'};
  const i={pending:'â³',approved:'âœ…',rejected:'âŒ'};
  return `<span class="status-pill ${c[s]||'pill-pending'}">${i[s]||''} ${s||'pending'}</span>`;
}
function X(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetailModal(id) {
  const b = allBookings.find(x => x.id === id);
  if (!b) return;
  activeModal = b;

  document.getElementById('modal-title').textContent = 'Booking â€” ' + (b.booking_id || id);

  const fields = [
    ['Name',b.name],['Email',b.email],
    ['Phone',b.phone],['Booking ID',b.booking_id],
    ['Tickets',(b.quantity||'â€”')+' Ã— â‚¹100'],['Total','â‚¹'+(b.total_amount||'â€”')],
    ['Event',b.event_name],['Date & Time',`${b.event_date||'â€”'} Â· ${b.event_time||'â€”'}`],
    ['Venue',b.venue],['UTR / Transaction ID',b.transaction_id],
    ['Status',b.approval_status],
    ['Submitted',b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN') : 'â€”'],
  ];
  document.getElementById('modal-details').innerHTML = fields.map(([l,v],i) =>
    `<div class="detail-item ${i>=fields.length-2?'wide':''}"><label>${l}</label><span>${X(String(v||'â€”'))}</span></div>`
  ).join('');

  // Screenshot
  const wrap  = document.getElementById('modal-ss-wrap');
  const img   = document.getElementById('modal-ss-img');
  const link  = document.getElementById('modal-ss-link');
  const ssBtn = document.getElementById('modal-ss-open-btn');
  if (b.screenshot_url) {
    img.src = ssUrl(b.screenshot_url); link.href = ssUrl(b.screenshot_url);
    wrap.classList.remove('hidden'); ssBtn.classList.remove('hidden');
  } else {
    wrap.classList.add('hidden'); ssBtn.classList.add('hidden');
  }

  const pnd = b.approval_status === 'pending';
  document.getElementById('modal-approve-btn').style.display = pnd ? '' : 'none';
  document.getElementById('modal-reject-btn').style.display  = pnd ? '' : 'none';
  document.getElementById('detail-modal').classList.remove('hidden');
}
function closeDetailModal() {
  document.getElementById('detail-modal').classList.add('hidden');
  activeModal = null;
}
async function modalAction(status) {
  if (!activeModal) return;
  const id = activeModal.id;
  closeDetailModal();
  await updateStatus(id, status);
}
function deleteFromModal() {
  if (!activeModal) return;
  const id = activeModal.id;
  closeDetailModal();
  confirmSingleDelete(id);
}
document.getElementById('detail-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('detail-modal')) closeDetailModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENSHOT LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(src, label) {
  if (!src) return;
  document.getElementById('lb-img').src = src;
  document.getElementById('lb-img').classList.remove('zoomed');
  document.getElementById('lb-info').textContent = (label ? label + ' â€” ' : '') + 'Click image to zoom';
  document.getElementById('lightbox').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').classList.add('hidden');
  document.getElementById('lb-img').classList.remove('zoomed');
  document.body.style.overflow = '';
}
function toggleLbZoom() {
  const img = document.getElementById('lb-img');
  img.classList.toggle('zoomed');
  document.getElementById('lb-info').textContent =
    img.classList.contains('zoomed') ? 'Zoomed in â€” click to zoom out' : 'Click image to zoom';
}
document.getElementById('lightbox').addEventListener('click', e => {
  if (e.target === document.getElementById('lightbox')) closeLightbox();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPARE FEATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCompare(id) {
  if (compareList.includes(id)) {
    compareList = compareList.filter(x => x !== id);
  } else {
    if (compareList.length >= 2) { showToast('Max 2 bookings. Remove one first.', true); return; }
    compareList.push(id);
  }
  syncCompareBar();
  applyFilters(); // re-render so button highlights update
}
function syncCompareBar() {
  const bar = document.getElementById('compare-bar');
  const btn = document.getElementById('cmp-go-btn');
  if (!compareList.length) { bar.classList.add('hidden'); return; }
  bar.classList.remove('hidden');
  document.getElementById('cbar-tags').innerHTML = compareList.map(id => {
    const b = allBookings.find(x => x.id === id);
    return `<span class="cbar-tag">${b ? X(b.booking_id || b.name || id.slice(0,8)) : id.slice(0,8)}</span>`;
  }).join('');
  if (compareList.length < 2) { btn.disabled = true; btn.textContent = 'Select 1 more â†’'; }
  else { btn.disabled = false; btn.textContent = 'Compare Now â†’'; }
}
function clearCompare() { compareList = []; syncCompareBar(); applyFilters(); }

function openCompareModal() {
  if (compareList.length < 2) return;
  const [a, b] = compareList.map(id => allBookings.find(x => x.id === id));
  if (!a || !b) return;

  const FIELDS = [
    ['Name','name'],['Email','email'],['Phone','phone'],
    ['Booking ID','booking_id'],['Tickets','quantity'],['Amount','total_amount'],
    ['UTR / Transaction ID','transaction_id'],['Event','event_name'],
    ['Date','event_date'],['Time','event_time'],['Venue','venue'],
    ['Status','approval_status'],['Submitted','submitted_at'],
  ];

  function colHTML(main, other) {
    return `<div class="cmp-col">
      <div class="cmp-col-title">${X(main.booking_id||main.name||'Booking')}</div>
      ${FIELDS.map(([label, key]) => {
        let va = main[key] ?? 'â€”', vb = other[key] ?? 'â€”';
        if (key === 'submitted_at') {
          va = va !== 'â€”' ? new Date(va).toLocaleString('en-IN') : 'â€”';
          vb = vb !== 'â€”' ? new Date(vb).toLocaleString('en-IN') : 'â€”';
        }
        if (key === 'total_amount') { va = va !== 'â€”' ? 'â‚¹'+va : 'â€”'; vb = vb !== 'â€”' ? 'â‚¹'+vb : 'â€”'; }
        const diff = String(va) !== String(vb);
        return `<div class="cmp-field${diff?' diff':''}">
          <label>${label}</label>
          <span>${X(String(va))}</span>
        </div>`;
      }).join('')}
      ${main.screenshot_url
        ? `<img class="cmp-ss" src="${main.screenshot_url}" onclick="openLightbox('${main.screenshot_url}','${X(main.name||'')}')" title="Click to enlarge">`
        : `<div class="cmp-no-ss">No screenshot uploaded</div>`}
    </div>`;
  }

  document.getElementById('compare-grid').innerHTML = colHTML(a, b) + colHTML(b, a);
  document.getElementById('compare-modal').classList.remove('hidden');
}
function closeCompareModal() { document.getElementById('compare-modal').classList.add('hidden'); }
document.getElementById('compare-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('compare-modal')) closeCompareModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKET VERIFY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doVerify() {
  const q   = document.getElementById('verify-input').value.trim().toLowerCase();
  const el  = document.getElementById('verify-result');
  if (!q) { showToast('Enter a Booking ID or UTR to verify.', true); return; }

  const b = allBookings.find(x =>
    (x.booking_id||'').toLowerCase() === q ||
    (x.transaction_id||'').toLowerCase() === q ||
    (x.booking_id||'').toLowerCase().includes(q)
  );

  el.classList.remove('hidden');

  if (!b) {
    el.innerHTML = `
      <div class="v-banner notfound">
        <div class="v-banner-icon">ğŸš«</div>
        <div class="v-banner-text">
          <h4>Ticket Not Found</h4>
          <p>No booking matches "<strong>${X(q)}</strong>". Check the ID and try again.</p>
        </div>
      </div>`;
    return;
  }

  const s = b.approval_status || 'pending';
  const icons = {approved:'âœ…',pending:'â³',rejected:'âŒ'};
  const msgs  = {
    approved:'This ticket is VALID and approved for entry.',
    pending: 'This ticket is pending approval â€” not yet confirmed.',
    rejected:'This ticket has been rejected and is not valid.'
  };
  const dt = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN') : 'â€”';

  el.innerHTML = `
    <div class="v-banner ${s}">
      <div class="v-banner-icon">${icons[s]||'â³'}</div>
      <div class="v-banner-text">
        <h4>${s.toUpperCase()}</h4>
        <p>${msgs[s]||''}</p>
      </div>
    </div>
    <div class="v-detail-grid">
      <div class="v-field"><label>Name</label><span>${X(b.name||'â€”')}</span></div>
      <div class="v-field"><label>Email</label><span>${X(b.email||'â€”')}</span></div>
      <div class="v-field"><label>Phone</label><span>${b.phone||'â€”'}</span></div>
      <div class="v-field"><label>Booking ID</label><span style="font-family:var(--mono)">${b.booking_id||'â€”'}</span></div>
      <div class="v-field"><label>Tickets</label><span>${b.quantity||'â€”'} ticket(s)</span></div>
      <div class="v-field"><label>Amount</label><span style="color:var(--amber);font-weight:700">â‚¹${b.total_amount||'â€”'}</span></div>
      <div class="v-field"><label>Event</label><span>${X(b.event_name||'â€”')}</span></div>
      <div class="v-field"><label>Venue</label><span>${X(b.venue||'â€”')}</span></div>
      <div class="v-field"><label>UTR / Transaction ID</label><span style="font-family:var(--mono)">${b.transaction_id||'â€”'}</span></div>
      <div class="v-field"><label>Submitted</label><span>${dt}</span></div>
    </div>
    ${b.screenshot_url ? `
      <div style="margin-top:.5rem;font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ash);margin-bottom:8px">Payment Screenshot</div>
      <img class="v-ss" src="${ssUrl(b.screenshot_url)}" onclick="openLightbox('${ssUrl(b.screenshot_url)}','${X(b.name||'')}')" title="Click to enlarge">
    ` : ''}
    ${s === 'pending' ? `
      <div class="v-actions">
        <button class="action-btn approve-btn" onclick="updateStatus('${b.id}','approved');setTimeout(doVerify,400)">âœ… Approve This Ticket</button>
        <button class="action-btn reject-btn"  onclick="updateStatus('${b.id}','rejected');setTimeout(doVerify,400)">âŒ Reject</button>
      </div>` : ''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE â€” SINGLE & BULK & CLEAR ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bulkSelected = new Set();
let confirmCallback = null;

// Checkbox: single row
function toggleRowSelect(chk) {
  const id = chk.dataset.id;
  if (chk.checked) bulkSelected.add(id);
  else bulkSelected.delete(id);
  syncBulkBar();
  // tint row
  const row = document.getElementById('row-' + id);
  if (row) row.style.background = chk.checked ? 'rgba(255,23,68,.05)' : '';
}

// Checkbox: select all visible
function toggleSelectAll(chk) {
  document.querySelectorAll('.row-chk').forEach(c => {
    c.checked = chk.checked;
    const id = c.dataset.id;
    if (chk.checked) bulkSelected.add(id);
    else bulkSelected.delete(id);
    const row = document.getElementById('row-' + id);
    if (row) row.style.background = chk.checked ? 'rgba(255,23,68,.05)' : '';
  });
  syncBulkBar();
}

function syncBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const cnt = document.getElementById('bulk-count');
  const btn = document.getElementById('bulk-del-btn');
  if (!bulkSelected.size) { bar.classList.add('hidden'); return; }
  bar.classList.remove('hidden');
  cnt.textContent = `${bulkSelected.size} booking${bulkSelected.size>1?'s':''} selected`;
  btn.textContent = `ğŸ—‘ï¸ Delete ${bulkSelected.size} Selected`;
}

function clearBulkSelect() {
  bulkSelected.clear();
  document.querySelectorAll('.row-chk').forEach(c => { c.checked = false; });
  const ca = document.getElementById('chk-all');
  if (ca) ca.checked = false;
  document.querySelectorAll('tr[id^="row-"]').forEach(r => r.style.background = '');
  syncBulkBar();
}

// â”€â”€ Confirm modal wiring â”€â”€
function showConfirm(title, msg, okLabel, cb) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').innerHTML = msg;
  document.getElementById('confirm-ok-btn').textContent = okLabel;
  confirmCallback = cb;
  document.getElementById('confirm-modal').classList.remove('hidden');
}
function confirmOk() {
  closeConfirm();
  if (confirmCallback) confirmCallback();
}
function closeConfirm() {
  document.getElementById('confirm-modal').classList.add('hidden');
  confirmCallback = null;
}
document.getElementById('confirm-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('confirm-modal')) closeConfirm();
});

// â”€â”€ Single delete â”€â”€
function confirmSingleDelete(id) {
  const b = allBookings.find(x => x.id === id);
  const name = b ? (b.name || b.booking_id || 'this booking') : 'this booking';
  showConfirm(
    'Delete Booking?',
    `You are about to permanently delete <span class="confirm-highlight">${X(name)}</span>.<br>This cannot be undone.`,
    'ğŸ—‘ï¸ Yes, Delete',
    () => deleteBookings([id])
  );
}

// â”€â”€ Bulk delete â”€â”€
function confirmBulkDelete() {
  const n = bulkSelected.size;
  if (!n) return;
  showConfirm(
    `Delete ${n} Booking${n>1?'s':''}?`,
    `You are about to permanently delete <span class="confirm-highlight">${n} booking${n>1?'s':''}</span>.<br>This cannot be undone.`,
    `ğŸ—‘ï¸ Delete ${n} Booking${n>1?'s':''}`,
    () => deleteBookings([...bulkSelected])
  );
}

// â”€â”€ Clear all visible (respects current filter) â”€â”€
function confirmClearAll() {
  const ids = filteredBkgs.map(b => b.id);
  if (!ids.length) { showToast('No bookings to delete.', true); return; }
  const filterLabel = curFilter === 'all' ? 'ALL bookings' : `all ${curFilter.toUpperCase()} bookings`;
  showConfirm(
    'Clear All?',
    `You are about to delete <span class="confirm-highlight">${ids.length} ${filterLabel}</span>.<br><br>This is permanent and cannot be undone.`,
    `ğŸ—‘ï¸ Delete All ${ids.length}`,
    () => deleteBookings(ids)
  );
}

// â”€â”€ Execute delete â”€â”€
async function deleteBookings(ids) {
  if (!ids.length) return;
  let failed = 0;
  // Supabase REST DELETE supports filtering by id using `in`
  try {
    // Build id list query: id=in.(id1,id2,...)
    const idList = ids.map(id => id).join(',');
    const res = await fetch(`${SB_URL}/rest/v1/ticket_bookings?id=in.(${idList})`, {
      method: 'DELETE',
      headers: { ...H, 'Prefer': 'return=minimal' }
    });
    if (!res.ok) { failed = ids.length; }
  } catch(e) { failed = ids.length; }

  if (failed) { showToast('Delete failed. Check permissions.', true); return; }

  // Remove from local state
  const deleted = new Set(ids);
  allBookings = allBookings.filter(b => !deleted.has(b.id));
  bulkSelected.clear();
  syncBulkBar();
  updateStats();
  applyFilters();
  if (curPage === 'approved' || curPage === 'rejected') renderSubTable(curPage);
  showToast(`ğŸ—‘ï¸ Deleted ${ids.length} booking${ids.length>1?'s':''}.`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateStatus(id, status) {
  try {
    const res = await fetch(`${SB_URL}/rest/v1/ticket_bookings?id=eq.${id}`, {
      method:'PATCH',
      headers:{...H,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({approval_status:status,approved_at:new Date().toISOString(),approved_by:'admin'})
    });
    if (!res.ok) { showToast('Update failed: ' + res.status, true); return; }
    const idx = allBookings.findIndex(x => x.id === id);
    if (idx !== -1) { allBookings[idx].approval_status = status; allBookings[idx].approved_at = new Date().toISOString(); }
    updateStats(); applyFilters();
    if (curPage === 'approved' || curPage === 'rejected') renderSubTable(curPage);
    showToast(status === 'approved' ? 'âœ… Booking approved!' : 'âŒ Booking rejected.');
  } catch(e) { showToast('Network error: ' + e.message, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST + KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, isErr) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (isErr ? ' error' : '');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 2800);
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeLightbox();
    closeDetailModal();
    closeCompareModal();
    closeConfirm();
  }
});

// Auto-refresh every 60s
setInterval(() => loadBookings(), 60_000);
</script>
</body>
</html>
