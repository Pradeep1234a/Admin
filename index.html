<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ğŸ¬ Admin â€” Movie Time Festival 2026</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ TOKENS â”€â”€â”€ */
:root{
  --bg:#08090c;--surface:#0f1117;--card:#161a22;--border:#1e2330;--border2:#252c3a;
  --t1:#f0f2f8;--t2:#8892a4;--t3:#4a5568;--t4:#2d3748;
  --flame:#ff5c1a;--flame2:#ff7a40;--amber:#f59e0b;
  --green:#10b981;--green2:#34d399;--red:#ef4444;--red2:#f87171;
  --blue:#3b82f6;--blue2:#60a5fa;--yellow:#f59e0b;--purple:#8b5cf6;
  --r:10px;--r2:8px;--r3:6px;
  --fn:'Inter',sans-serif;--fm:'JetBrains Mono',monospace;
  --nav:56px;--sb:240px;
  --sh-card:0 1px 3px rgba(0,0,0,.4),0 1px 2px rgba(0,0,0,.3);
  --sh-modal:0 25px 50px rgba(0,0,0,.8);
}
*,::before,::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%}
body{font-family:var(--fn);background:var(--bg);color:var(--t1);min-height:100vh;-webkit-font-smoothing:antialiased}
button,input,select{font-family:var(--fn)}
a{color:var(--blue2);text-decoration:none}
a:hover{text-decoration:underline}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.hidden{display:none!important}

/* â”€â”€â”€ APP SHELL â”€â”€â”€ */
.app{display:grid;grid-template-columns:var(--sb) 1fr;min-height:100vh}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar{
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;
  z-index:50;
}
.sb-brand{padding:1.25rem 1.2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem}
.sb-brand-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--flame),#c53012);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;box-shadow:0 4px 12px rgba(255,92,26,.3)}
.sb-brand-text{min-width:0}
.sb-brand-name{font-size:.88rem;font-weight:800;color:var(--t1);letter-spacing:-.01em}
.sb-brand-sub{font-size:.6rem;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;margin-top:1px}
.sb-nav{padding:.75rem .6rem;flex:1}
.sb-section{font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--t4);padding:8px 10px 4px;margin-top:4px}
.sb-item{
  display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--r2);
  color:var(--t2);font-size:.83rem;font-weight:500;cursor:pointer;
  margin-bottom:2px;transition:all .15s;border:1px solid transparent;
  text-decoration:none;
}
.sb-item:hover{background:var(--card);color:var(--t1)}
.sb-item.active{background:rgba(255,92,26,.1);color:var(--flame2);border-color:rgba(255,92,26,.18);font-weight:600}
.sb-item svg{flex-shrink:0;opacity:.7}
.sb-item.active svg{opacity:1}
.sb-badge{margin-left:auto;border-radius:20px;padding:1px 6px;font-size:.58rem;font-weight:800;min-width:18px;text-align:center;line-height:1.6}
.sb-badge.orange{background:var(--flame);color:#fff}
.sb-badge.blue{background:var(--blue);color:#fff}
.sb-badge.red{background:var(--red);color:#fff}
.sb-divider{height:1px;background:var(--border);margin:.5rem .6rem}
.sb-foot{padding:.75rem 1.2rem;border-top:1px solid var(--border)}
.sb-foot-row{display:flex;align-items:center;gap:.5rem}
.sb-foot-dot{width:7px;height:7px;background:var(--green2);border-radius:50%;box-shadow:0 0 6px var(--green2);flex-shrink:0}
.sb-foot-txt{font-size:.7rem;color:var(--t3)}

/* â”€â”€â”€ MAIN â”€â”€â”€ */
.main{display:flex;flex-direction:column;min-width:0;overflow-x:hidden}

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:.85rem 1.5rem;display:flex;align-items:center;
  justify-content:space-between;gap:1rem;position:sticky;top:0;z-index:40;
}
.topbar-left{display:flex;align-items:center;gap:.75rem;min-width:0}
.topbar-left h1{font-size:.95rem;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topbar-crumb{font-size:.75rem;color:var(--t3)}
.topbar-right{display:flex;align-items:center;gap:.5rem;flex-shrink:0}
.pill-admin{background:rgba(255,92,26,.12);border:1px solid rgba(255,92,26,.25);border-radius:20px;padding:3px 10px;font-size:.65rem;font-weight:700;color:var(--flame2);letter-spacing:.04em}
.btn-icon{background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:6px 10px;color:var(--t2);font-size:.75rem;font-weight:600;display:flex;align-items:center;gap:5px;transition:all .15s}
.btn-icon:hover{background:var(--border);color:var(--t1)}
.btn-icon svg{flex-shrink:0}

/* â”€â”€â”€ CONTENT â”€â”€â”€ */
.content{padding:1.25rem;flex:1}
.page{display:none}
.page.active{display:block}

/* â”€â”€â”€ STATS GRID â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(6,1fr);gap:.75rem;margin-bottom:1.25rem}
.stat{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1rem 1.1rem;position:relative;overflow:hidden;transition:border-color .2s}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:0;transition:opacity .2s}
.stat:hover{border-color:var(--border2)}
.stat.s-income::before{background:linear-gradient(90deg,var(--green),var(--green2));opacity:1}
.stat.s-sells::before{background:linear-gradient(90deg,var(--flame),var(--flame2));opacity:1}
.stat.s-income,.stat.s-sells{border-color:rgba(255,255,255,.06)}
.stat-ico{font-size:1.1rem;margin-bottom:.5rem}
.stat-lbl{font-size:.62rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--t3);margin-bottom:.35rem}
.stat-val{font-size:1.65rem;font-weight:800;line-height:1;letter-spacing:-.02em}
.stat-sub{font-size:.62rem;color:var(--t3);margin-top:.3rem}
.v-green{color:var(--green2)}.v-orange{color:var(--flame2)}.v-yellow{color:var(--amber)}.v-red{color:var(--red2)}.v-blue{color:var(--blue2)}

/* â”€â”€â”€ TOOLBAR â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:.6rem;margin-bottom:.9rem;flex-wrap:wrap}
.filter-tabs{display:flex;gap:3px;background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:3px}
.ftab{padding:5px 12px;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--t2);transition:all .14s;white-space:nowrap}
.ftab:hover{color:var(--t1)}
.ftab.active{background:var(--border2);color:var(--t1);box-shadow:0 1px 2px rgba(0,0,0,.3)}
.search-wrap{flex:1;min-width:180px;position:relative}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--t3);pointer-events:none}
.search-inp{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:7px 12px 7px 32px;color:var(--t1);font-family:var(--fn);font-size:.8rem;transition:border-color .15s}
.search-inp:focus{outline:none;border-color:rgba(255,92,26,.4)}
.search-inp::placeholder{color:var(--t3)}
.toolbar-actions{display:flex;gap:.5rem;margin-left:auto}

/* â”€â”€â”€ SELECTION BAR â”€â”€â”€ */
.sel-bar{
  display:flex;align-items:center;gap:.75rem;padding:.7rem 1rem;
  background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);
  border-radius:var(--r);margin-bottom:.9rem;flex-wrap:wrap;
}
.sel-bar-info{font-size:.8rem;color:var(--red2);font-weight:600;flex:1}
.sel-bar-acts{display:flex;gap:.5rem}

/* â”€â”€â”€ COMPARE BAR â”€â”€â”€ */
.cmp-bar{
  display:flex;align-items:center;gap:.75rem;padding:.7rem 1rem;
  background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);
  border-radius:var(--r);margin-bottom:.9rem;flex-wrap:wrap;
}
.cmp-bar-lbl{font-size:.78rem;color:var(--amber);font-weight:700;white-space:nowrap}
.cmp-tags{display:flex;gap:5px;flex:1;flex-wrap:wrap}
.cmp-tag{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.25);border-radius:20px;padding:2px 9px;font-size:.68rem;color:var(--amber);font-weight:600}
.cmp-bar-acts{display:flex;gap:.5rem}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--r2);font-family:var(--fn);font-size:.73rem;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .14s;white-space:nowrap;line-height:1.2}
.btn svg{flex-shrink:0;width:13px;height:13px}
/* variants */
.btn-ghost{background:transparent;color:var(--t2);border-color:var(--border2)}.btn-ghost:hover{background:var(--card);color:var(--t1)}
.btn-primary{background:var(--flame);color:#fff;border-color:var(--flame);box-shadow:0 2px 8px rgba(255,92,26,.25)}.btn-primary:hover{background:var(--flame2)}
.btn-green{background:rgba(16,185,129,.12);color:var(--green2);border-color:rgba(16,185,129,.25)}.btn-green:hover{background:rgba(16,185,129,.2)}
.btn-red{background:rgba(239,68,68,.1);color:var(--red2);border-color:rgba(239,68,68,.22)}.btn-red:hover{background:rgba(239,68,68,.2)}
.btn-red-solid{background:var(--red);color:#fff;border-color:var(--red);box-shadow:0 2px 8px rgba(239,68,68,.3)}.btn-red-solid:hover{background:var(--red2)}
.btn-blue{background:rgba(59,130,246,.1);color:var(--blue2);border-color:rgba(59,130,246,.22)}.btn-blue:hover{background:rgba(59,130,246,.2)}
.btn-amber{background:rgba(245,158,11,.1);color:var(--amber);border-color:rgba(245,158,11,.22)}.btn-amber:hover{background:rgba(245,158,11,.2)}
.btn-amber.on{background:rgba(245,158,11,.25);border-color:var(--amber);color:var(--amber)}
.btn-sm{padding:4px 9px;font-size:.68rem}
.btn-lg{padding:9px 18px;font-size:.82rem}
.btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none}
.btn-danger-outline{background:transparent;color:var(--red2);border-color:rgba(239,68,68,.3)}.btn-danger-outline:hover{background:rgba(239,68,68,.1)}

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.tbl-wrap{border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.tbl-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.78rem}
thead{background:var(--card)}
th{
  padding:10px 13px;text-align:left;font-size:.62rem;font-weight:700;
  letter-spacing:.07em;text-transform:uppercase;color:var(--t3);
  white-space:nowrap;border-bottom:1px solid var(--border);
}
th:first-child{width:40px;padding-right:0}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.02)}
tbody tr.selected{background:rgba(239,68,68,.04)}
td{padding:11px 13px;vertical-align:middle}
td:first-child{padding-right:0}
.td-mono{font-family:var(--fm);font-size:.73rem;color:var(--t2)}
.td-name{font-weight:600;color:var(--t1)}
.td-muted{color:var(--t2);font-size:.76rem}
.td-amt{font-weight:700;color:var(--amber)}
input[type=checkbox]{
  width:15px;height:15px;cursor:pointer;
  accent-color:var(--flame);vertical-align:middle;
}

/* â”€â”€â”€ STATUS PILLS â”€â”€â”€ */
.pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:.62rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
.pill-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.pill-pending{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.pill-pending .pill-dot{background:var(--amber)}
.pill-approved{background:rgba(16,185,129,.1);color:var(--green2);border:1px solid rgba(16,185,129,.2)}
.pill-approved .pill-dot{background:var(--green2)}
.pill-rejected{background:rgba(239,68,68,.1);color:var(--red2);border:1px solid rgba(239,68,68,.2)}
.pill-rejected .pill-dot{background:var(--red2)}

/* â”€â”€â”€ MOBILE CARDS â”€â”€â”€ */
.card-grid{display:none;flex-direction:column;gap:.6rem}
.bk-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1rem;transition:border-color .15s}
.bk-card:hover{border-color:var(--border2)}
.bk-card.selected{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.03)}
.bk-card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:.5rem;margin-bottom:.65rem}
.bk-card-id{font-family:var(--fm);font-size:.65rem;color:var(--t3);margin-top:2px}
.bk-card-name{font-weight:700;color:var(--t1);font-size:.88rem}
.bk-card-body{display:grid;grid-template-columns:1fr 1fr;gap:.3rem .6rem;margin-bottom:.7rem}
.bk-field label{display:block;font-size:.56rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--t3);margin-bottom:1px}
.bk-field span{font-size:.76rem;color:var(--t2)}
.bk-field span.hi{color:var(--amber);font-weight:700}
.bk-card-foot{display:flex;gap:.4rem;flex-wrap:wrap}

/* â”€â”€â”€ OVERLAYS â”€â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:800;display:flex;align-items:center;justify-content:center;padding:1rem;overflow-y:auto}
.ov.hidden{display:none}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:14px;width:100%;box-shadow:var(--sh-modal);margin:auto}
.modal-sm{max-width:380px}
.modal-md{max-width:560px}
.modal-lg{max-width:820px}
.modal-hd{padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);border-radius:14px 14px 0 0;z-index:1}
.modal-hd h3{font-size:.92rem;font-weight:700;color:var(--t1)}
.modal-hd .modal-sub{font-size:.72rem;color:var(--t3);margin-top:1px}
.modal-x{background:var(--border);border:none;color:var(--t2);width:28px;height:28px;border-radius:50%;font-size:.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .14s}
.modal-x:hover{background:var(--border2);color:var(--t1)}
.modal-body{padding:1.25rem 1.4rem;max-height:70vh;overflow-y:auto}
.modal-ft{padding:.9rem 1.4rem;border-top:1px solid var(--border);display:flex;gap:.5rem;flex-wrap:wrap}
.modal-ft .btn{flex:1}

/* â”€â”€â”€ DETAIL GRID â”€â”€â”€ */
.det-grid{display:grid;grid-template-columns:1fr 1fr;gap:.85rem}
.det-field label{display:block;font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--t3);margin-bottom:3px}
.det-field span{font-size:.83rem;color:var(--t1);word-break:break-all}
.det-field.span2{grid-column:1/-1}

/* â”€â”€â”€ SCREENSHOT BLOCK â”€â”€â”€ */
.ss-block{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
.ss-block-lbl{font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--t3);margin-bottom:.5rem}
.ss-img{width:100%;border-radius:var(--r2);border:1px solid var(--border2);cursor:zoom-in;display:block;transition:border-color .15s;max-height:300px;object-fit:contain;background:var(--surface)}
.ss-img:hover{border-color:var(--flame)}
.ss-hint{font-size:.65rem;color:var(--t3);margin-top:.4rem;display:flex;align-items:center;justify-content:space-between}

/* â”€â”€â”€ LIGHTBOX â”€â”€â”€ */
#lb{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:1200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem}
.lb-x{position:fixed;top:12px;right:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;width:38px;height:38px;border-radius:50%;font-size:1rem;display:flex;align-items:center;justify-content:center;z-index:1201;cursor:pointer;transition:background .15s}
.lb-x:hover{background:rgba(255,255,255,.16)}
#lb-img{max-width:90vw;max-height:78vh;border-radius:var(--r);object-fit:contain;cursor:zoom-in;display:block}
#lb-img.zm{max-width:none;max-height:none;cursor:zoom-out}
.lb-caption{color:var(--t2);font-size:.72rem;margin-top:.6rem;text-align:center}
.lb-bar{display:flex;gap:.5rem;margin-top:.6rem;flex-wrap:wrap;justify-content:center}
.lb-btn{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:var(--t1);padding:7px 14px;border-radius:var(--r2);font-family:var(--fn);font-size:.75rem;font-weight:600;cursor:pointer;transition:background .14s}
.lb-btn:hover{background:rgba(255,255,255,.13)}
.lb-btn.blue{background:rgba(59,130,246,.15);color:var(--blue2);border-color:rgba(59,130,246,.3)}

/* â”€â”€â”€ COMPARE â”€â”€â”€ */
.cmp-cols{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.cmp-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1rem;overflow-y:auto}
.cmp-col-hd{font-size:.65rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--amber);margin-bottom:.85rem;padding-bottom:.5rem;border-bottom:1px solid var(--border)}
.cmp-row{margin-bottom:.6rem}
.cmp-row label{display:block;font-size:.58rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--t3);margin-bottom:2px}
.cmp-row span{font-size:.8rem;color:var(--t1);word-break:break-all}
.cmp-row.diff span{color:var(--amber)}
.cmp-row.diff label::after{content:' âš ';color:var(--amber)}

/* â”€â”€â”€ CONFIRM MODAL â”€â”€â”€ */
.cf-body{padding:2rem 1.4rem;text-align:center}
.cf-ico{font-size:2.5rem;line-height:1;margin-bottom:.75rem}
.cf-body h4{font-size:.98rem;font-weight:800;color:var(--t1);margin-bottom:.4rem}
.cf-body p{font-size:.8rem;color:var(--t2);line-height:1.65}
.cf-body .hi{color:var(--red2);font-weight:700}
.cf-count{
  display:inline-block;margin:.75rem 0 0;
  background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);
  border-radius:var(--r2);padding:.5rem 1rem;
  font-size:.82rem;font-weight:700;color:var(--red2);
}

/* â”€â”€â”€ GALLERY â”€â”€â”€ */
.gal-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:.9rem;flex-wrap:wrap;gap:.5rem}
.gal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:.75rem}
.gal-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:border-color .17s,transform .13s,box-shadow .17s}
.gal-card:hover{border-color:rgba(255,92,26,.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.gal-img-wrap{width:100%;aspect-ratio:4/3;background:var(--surface);overflow:hidden;position:relative}
.gal-img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity .2s,transform .3s}
.gal-img.loading{opacity:.25}
.gal-card:hover .gal-img{transform:scale(1.03)}
.gal-no-img{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--t4)}
.gal-status{position:absolute;top:7px;right:7px;font-size:.58rem;font-weight:800;padding:2px 7px;border-radius:20px;text-transform:uppercase}
.gal-body{padding:.7rem .8rem}
.gal-name{font-size:.72rem;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:2px}
.gal-meta{font-size:.62rem;color:var(--t3);margin-bottom:.4rem}
.gal-link{font-size:.62rem;color:var(--blue2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;margin-bottom:.45rem}
.gal-link:hover{text-decoration:underline}
.gal-unlinked{font-size:.62rem;color:var(--t4);font-style:italic;margin-bottom:.45rem}
.gal-acts{display:flex;gap:4px}

/* â”€â”€â”€ VERIFY â”€â”€â”€ */
.verify-wrap{max-width:520px;margin:0 auto}
.verify-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.25rem;margin-bottom:1rem;box-shadow:var(--sh-card)}
.verify-card h3{font-size:.9rem;font-weight:700;margin-bottom:.3rem}
.verify-card p{font-size:.76rem;color:var(--t2);margin-bottom:.8rem}
.verify-row{display:flex;gap:.5rem}
.verify-inp{flex:1;background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r2);padding:9px 12px;color:var(--t1);font-family:var(--fm);font-size:.83rem}
.verify-inp:focus{outline:none;border-color:rgba(255,92,26,.5)}
.verify-inp::placeholder{color:var(--t3)}
.verify-btn{background:var(--flame);color:#fff;border:none;border-radius:var(--r2);padding:9px 18px;font-family:var(--fn);font-size:.83rem;font-weight:700;cursor:pointer;transition:opacity .14s;white-space:nowrap}
.verify-btn:hover{opacity:.9}
/* verify result */
.v-banner{border-radius:var(--r2);padding:.85rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:12px}
.v-banner.approved{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2)}
.v-banner.pending{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2)}
.v-banner.rejected,.v-banner.notfound{background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2)}
.v-ico{font-size:1.8rem;flex-shrink:0}
.v-title{font-size:.9rem;font-weight:800;margin-bottom:2px}
.approved .v-title{color:var(--green2)}
.pending  .v-title{color:var(--amber)}
.rejected .v-title,.notfound .v-title{color:var(--red2)}
.v-msg{font-size:.74rem;color:var(--t2)}
.v-dg{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;margin-bottom:.75rem}
.v-field label{display:block;font-size:.58rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--t3);margin-bottom:2px}
.v-field span{font-size:.79rem;color:var(--t1)}
.v-acts{display:flex;gap:.5rem;margin-top:.75rem}
.v-acts .btn{flex:1;justify-content:center}

/* â”€â”€â”€ EMPTY / LOADING â”€â”€â”€ */
.empty-state{text-align:center;padding:3.5rem 1rem;color:var(--t3)}
.empty-ico{font-size:2.8rem;margin-bottom:.75rem;opacity:.5}
.empty-txt{font-size:.85rem;margin-bottom:.5rem}
.empty-sub{font-size:.74rem;color:var(--t4)}
.loader{text-align:center;padding:2.5rem;color:var(--t3);font-size:.82rem}
.spin{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--flame);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{
  position:fixed;bottom:72px;left:50%;transform:translateX(-50%) translateY(10px);
  background:var(--card);border:1px solid var(--border2);color:var(--t1);
  padding:8px 16px;border-radius:20px;font-size:.77rem;font-weight:600;
  z-index:2000;opacity:0;transition:all .24s;pointer-events:none;
  white-space:nowrap;max-width:88vw;overflow:hidden;text-overflow:ellipsis;
  box-shadow:0 8px 24px rgba(0,0,0,.6);display:flex;align-items:center;gap:6px;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast .t-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.toast.ok .t-dot{background:var(--green2)}
.toast.err .t-dot{background:var(--red)}

/* â”€â”€â”€ MOBILE NAV â”€â”€â”€ */
.mobnav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);z-index:200;height:var(--nav);grid-template-columns:repeat(5,1fr)}
.mni{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--t3);font-size:.52rem;font-weight:700;cursor:pointer;padding:5px 2px;text-transform:uppercase;letter-spacing:.04em;border-top:2px solid transparent;transition:all .13s;position:relative}
.mni.active{color:var(--flame2);border-top-color:var(--flame)}
.mni svg{flex-shrink:0}
.mn-badge{position:absolute;top:3px;right:calc(50% - 18px);background:var(--red);color:#fff;border-radius:20px;padding:1px 4px;font-size:.5rem;font-weight:800;min-width:14px;text-align:center}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:900px){
  .stats-row{grid-template-columns:repeat(3,1fr)}
}
@media(max-width:768px){
  .app{grid-template-columns:1fr}
  .sidebar{display:none}
  .mobnav{display:grid}
  .content{padding:.85rem;padding-bottom:calc(var(--nav) + .85rem)}
  .topbar{padding:.7rem 1rem}
  .stats-row{grid-template-columns:1fr 1fr;gap:.6rem}
  .stat-val{font-size:1.4rem}
  .tbl-wrap{display:none}
  .card-grid{display:flex}
  .det-grid{grid-template-columns:1fr}
  .cmp-cols{grid-template-columns:1fr}
  .v-dg{grid-template-columns:1fr}
  .gal-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem}
  .toast{bottom:calc(var(--nav) + 10px)}
  .verify-wrap{max-width:100%}
  .modal-lg{max-width:100%}
  .toolbar{gap:.5rem}
  .toolbar-actions{width:100%;justify-content:flex-end}
}
@media(min-width:769px){
  .toast{bottom:20px}
}
</style>
</head>
<body>

<div class="app">

<!-- â•â•â•â•â• SIDEBAR â•â•â•â•â• -->
<aside class="sidebar">
  <div class="sb-brand">
    <div class="sb-brand-icon">ğŸ¬</div>
    <div class="sb-brand-text">
      <div class="sb-brand-name">Movie Time</div>
      <div class="sb-brand-sub">Festival 2026 Â· Admin</div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Bookings</div>
    <div class="sb-item active" id="sb-bookings" onclick="goPage('bookings',this)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      All Bookings
      <span class="sb-badge orange" id="sb-pend">0</span>
    </div>
    <div class="sb-item" id="sb-approved" onclick="goPage('approved',this)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      Approved
    </div>
    <div class="sb-item" id="sb-rejected" onclick="goPage('rejected',this)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
      Rejected
    </div>
    <div class="sb-divider"></div>
    <div class="sb-section">Tools</div>
    <div class="sb-item" id="sb-screenshots" onclick="goPage('screenshots',this)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      Screenshots
      <span class="sb-badge blue" id="sb-ssc">0</span>
    </div>
    <div class="sb-item" id="sb-verify" onclick="goPage('verify',this)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Ticket Verify
    </div>
  </nav>
  <div class="sb-foot">
    <div class="sb-foot-row">
      <div class="sb-foot-dot"></div>
      <div class="sb-foot-txt">Live &nbsp;Â·&nbsp; Auto-refresh 60s</div>
    </div>
  </div>
</aside>

<!-- â•â•â•â•â• MAIN â•â•â•â•â• -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="ptitle">All Bookings</h1>
    </div>
    <div class="topbar-right">
      <span class="pill-admin">Admin</span>
      <button class="btn-icon" onclick="loadBookings()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="content">

    <!-- â”€â”€ PAGE: BOOKINGS â”€â”€ -->
    <div class="page active" id="page-bookings">

      <div class="stats-row">
        <div class="stat s-income">
          <div class="stat-ico">ğŸ’°</div>
          <div class="stat-lbl">Ticket Income</div>
          <div class="stat-val v-green" id="st-income">â‚¹0</div>
          <div class="stat-sub">Approved bookings</div>
        </div>
        <div class="stat s-sells">
          <div class="stat-ico">ğŸŸï¸</div>
          <div class="stat-lbl">Tickets Sold</div>
          <div class="stat-val v-orange" id="st-sells">0</div>
          <div class="stat-sub">Total quantity</div>
        </div>
        <div class="stat">
          <div class="stat-lbl">Total Bookings</div>
          <div class="stat-val v-orange" id="st-total">â€”</div>
        </div>
        <div class="stat">
          <div class="stat-lbl">Pending</div>
          <div class="stat-val v-yellow" id="st-pend">â€”</div>
        </div>
        <div class="stat">
          <div class="stat-lbl">Approved</div>
          <div class="stat-val v-green" id="st-appr">â€”</div>
        </div>
        <div class="stat">
          <div class="stat-lbl">Rejected</div>
          <div class="stat-val v-red" id="st-reje">â€”</div>
        </div>
      </div>

      <!-- compare bar -->
      <div class="cmp-bar hidden" id="cmp-bar">
        <span class="cmp-bar-lbl">âš–ï¸ Compare</span>
        <div class="cmp-tags" id="cmp-tags"></div>
        <div class="cmp-bar-acts">
          <button class="btn btn-amber btn-sm" id="cmp-go" onclick="openCmp()" disabled>Pick 1 more</button>
          <button class="btn btn-ghost btn-sm" onclick="clearCmp()">âœ• Clear</button>
        </div>
      </div>

      <!-- selection bar (shown when rows checked) -->
      <div class="sel-bar hidden" id="sel-bar">
        <span class="sel-bar-info" id="sel-info">0 selected</span>
        <div class="sel-bar-acts">
          <button class="btn btn-ghost btn-sm" onclick="selAll(false)">Deselect all</button>
          <button class="btn btn-red btn-sm" onclick="askBulkDel()">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
            Delete Selected
          </button>
        </div>
      </div>

      <div class="toolbar">
        <div class="filter-tabs">
          <button class="ftab active" id="ft-all"      onclick="setFilt('all',this)">All</button>
          <button class="ftab"        id="ft-pending"  onclick="setFilt('pending',this)">Pending</button>
          <button class="ftab"        id="ft-approved" onclick="setFilt('approved',this)">Approved</button>
          <button class="ftab"        id="ft-rejected" onclick="setFilt('rejected',this)">Rejected</button>
        </div>
        <div class="search-wrap">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input class="search-inp" type="text" placeholder="Search name, email, ID, UTRâ€¦" oninput="doSearch(this.value)">
        </div>
        <div class="toolbar-actions">
          <button class="btn btn-danger-outline btn-sm" onclick="askClearAll()" id="clear-all-btn">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M9 6V4h6v2"/></svg>
            Clear All
          </button>
        </div>
      </div>

      <div class="tbl-wrap" id="tbl-main-wrap">
        <div id="tbl-main"><div class="loader"><span class="spin"></span>Loading bookingsâ€¦</div></div>
      </div>
      <div class="card-grid" id="cards-main"></div>
    </div>

    <!-- â”€â”€ PAGE: APPROVED â”€â”€ -->
    <div class="page" id="page-approved">
      <div class="tbl-wrap"><div id="tbl-approved"><div class="loader"><span class="spin"></span>Loadingâ€¦</div></div></div>
      <div class="card-grid" id="cards-approved"></div>
    </div>

    <!-- â”€â”€ PAGE: REJECTED â”€â”€ -->
    <div class="page" id="page-rejected">
      <div class="tbl-wrap"><div id="tbl-rejected"><div class="loader"><span class="spin"></span>Loadingâ€¦</div></div></div>
      <div class="card-grid" id="cards-rejected"></div>
    </div>

    <!-- â”€â”€ PAGE: SCREENSHOTS â”€â”€ -->
    <div class="page" id="page-screenshots">
      <div class="gal-bar">
        <span id="gal-info" style="font-size:.8rem;color:var(--t3)">Loadingâ€¦</span>
        <button class="btn btn-ghost btn-sm" onclick="loadSS()">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          Refresh
        </button>
      </div>
      <div id="gal-area"><div class="loader"><span class="spin"></span>Loading screenshotsâ€¦</div></div>
    </div>

    <!-- â”€â”€ PAGE: VERIFY â”€â”€ -->
    <div class="page" id="page-verify">
      <div class="verify-wrap">
        <div class="verify-card">
          <h3>ğŸ” Ticket Verifier</h3>
          <p>Enter a Booking ID or UTR / Transaction ID to verify instantly.</p>
          <div class="verify-row">
            <input class="verify-inp" type="text" id="vin" placeholder="Booking ID or UTR numberâ€¦" onkeydown="if(event.key==='Enter')doVerify()">
            <button class="verify-btn" onclick="doVerify()">Verify</button>
          </div>
        </div>
        <div class="hidden" id="vres"></div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- â•â•â•â•â• MOBILE NAV â•â•â•â•â• -->
<nav class="mobnav">
  <div class="mni active" id="mn-bookings" onclick="goPage('bookings',this)">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Bookings<span class="mn-badge hidden" id="mn-pend"></span>
  </div>
  <div class="mni" id="mn-approved" onclick="goPage('approved',this)">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    Approved
  </div>
  <div class="mni" id="mn-rejected" onclick="goPage('rejected',this)">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    Rejected
  </div>
  <div class="mni" id="mn-screenshots" onclick="goPage('screenshots',this)">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    Photos
  </div>
  <div class="mni" id="mn-verify" onclick="goPage('verify',this)">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Verify
  </div>
</nav>

<!-- â•â•â•â•â• DETAIL MODAL â•â•â•â•â• -->
<div class="ov hidden" id="ov-det">
  <div class="modal modal-md">
    <div class="modal-hd">
      <div><h3 id="det-title">Booking Details</h3><div class="modal-sub" id="det-sub"></div></div>
      <button class="modal-x" onclick="closeDet()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="det-grid" id="det-fields"></div>
      <div class="ss-block hidden" id="det-ss-wrap">
        <div class="ss-block-lbl">Payment Screenshot</div>
        <img id="det-ss-img" class="ss-img" src="" onclick="openLB_id('det')" alt="Payment screenshot">
        <div class="ss-hint">
          <span>Tap to zoom</span>
          <a id="det-ss-link" href="#" target="_blank">Open original â†—</a>
        </div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-green btn-lg" id="det-approve" onclick="detAction('approved')">âœ… Approve</button>
      <button class="btn btn-red   btn-lg" id="det-reject"  onclick="detAction('rejected')">âŒ Reject</button>
      <button class="btn btn-blue  btn-lg hidden" id="det-ss-btn" onclick="openLB_id('det')">ğŸ–¼ Screenshot</button>
      <button class="btn btn-ghost btn-lg" onclick="closeDet()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â• LIGHTBOX â•â•â•â•â• -->
<div id="lb" class="hidden">
  <button class="lb-x" onclick="closeLB()">âœ•</button>
  <img id="lb-img" src="" alt="Screenshot" onclick="toggleZoom()">
  <div class="lb-caption" id="lb-cap">Tap to zoom</div>
  <div class="lb-bar">
    <button class="lb-btn blue" id="lb-orig">â†— Open Full Size</button>
    <button class="lb-btn" onclick="toggleZoom()">ğŸ” Toggle Zoom</button>
    <button class="lb-btn" onclick="closeLB()">âœ• Close</button>
  </div>
</div>

<!-- â•â•â•â•â• COMPARE MODAL â•â•â•â•â• -->
<div class="ov hidden" id="ov-cmp">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3>âš–ï¸ Side-by-Side Comparison</h3>
      <button class="modal-x" onclick="closeOv('ov-cmp')">âœ•</button>
    </div>
    <div class="modal-body"><div class="cmp-cols" id="cmp-grid"></div></div>
  </div>
</div>

<!-- â•â•â•â•â• CONFIRM DELETE MODAL â•â•â•â•â• -->
<div class="ov hidden" id="ov-cf">
  <div class="modal modal-sm">
    <div class="modal-hd">
      <h3 id="cf-title">Confirm Delete</h3>
      <button class="modal-x" onclick="closeOv('ov-cf')">âœ•</button>
    </div>
    <div class="cf-body">
      <div class="cf-ico" id="cf-ico">ğŸ—‘ï¸</div>
      <h4 id="cf-h">Delete this booking?</h4>
      <p id="cf-p">This action is permanent and cannot be undone.</p>
      <div class="cf-count hidden" id="cf-count"></div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-red-solid btn-lg" id="cf-ok" onclick="cfOk()">ğŸ—‘ï¸ Delete</button>
      <button class="btn btn-ghost btn-lg" onclick="closeOv('ov-cf')">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><span class="t-dot"></span><span id="toast-msg"></span></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SB      = 'https://vjxidlnggrpbttxmrfch.supabase.co';
var KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqeGlkbG5nZ3JwYnR0eG1yZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjQ2MzYsImV4cCI6MjA4NzAwMDYzNn0.G7OXaE8hi-1ELJAmw_-gLi658henIj2NjIBqFd3HWWo';
var BUCKET  = 'payment-screenshots';
var PUBBASE = SB + '/storage/v1/object/public/' + BUCKET + '/';
var AH      = { apikey: KEY, Authorization: 'Bearer ' + KEY };

// Resolve raw screenshot_url â†’ full public URL
function ssUrl(raw) {
  if (!raw) return '';
  if (raw.indexOf('http') === 0) return raw;
  var clean = raw.replace(/^payment-screenshots\//, '').replace(/^\//, '');
  return PUBBASE + clean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL CACHES (safe integer keys for onclick)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var BK   = {};   // render-index â†’ booking
var BKID = {};   // id â†’ booking
var FM   = {};   // file-index â†’ file info

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var allBk    = [];
var filt     = [];
var curFilt  = 'all';
var curQ     = '';
var curPage  = 'bookings';
var detBk    = null;
var cmpIds   = [];
var selSet   = new Set();
var cfCb     = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadBookings();
loadSsCount();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(p, triggerEl) {
  curPage = p;
  // pages
  document.querySelectorAll('.page').forEach(function(x){ x.classList.remove('active'); });
  $('page-' + p).classList.add('active');
  // sidebar items
  document.querySelectorAll('.sb-item').forEach(function(x){ x.classList.remove('active'); });
  var sb = $('sb-' + p); if (sb) sb.classList.add('active');
  // mobile nav items
  document.querySelectorAll('.mni').forEach(function(x){ x.classList.remove('active'); });
  var mn = $('mn-' + p); if (mn) mn.classList.add('active');
  // title
  var titles = { bookings:'All Bookings', approved:'Approved', rejected:'Rejected', screenshots:'Screenshots', verify:'Ticket Verifier' };
  $('ptitle').textContent = titles[p] || p;

  if (p === 'approved')    renderSub('approved');
  if (p === 'rejected')    renderSub('rejected');
  if (p === 'screenshots') loadSS();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD BOOKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBookings() {
  html('tbl-main', loader());
  html('cards-main', '');
  try {
    var res = await fetch(SB + '/rest/v1/ticket_bookings?select=*&order=submitted_at.desc', { headers: AH });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    allBk = await res.json();
    BKID  = {};
    allBk.forEach(function(b){ BKID[b.id] = b; });
    updateStats();
    applyFilt();
    if (curPage === 'approved') renderSub('approved');
    if (curPage === 'rejected') renderSub('rejected');
  } catch(e) {
    html('tbl-main', emptyState('âš ï¸', e.message, ''));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  var appr = allBk.filter(function(b){ return b.approval_status === 'approved'; });
  var pend = allBk.filter(function(b){ return b.approval_status === 'pending'; }).length;
  txt('st-income', 'â‚¹' + appr.reduce(function(s,b){ return s + (b.total_amount||0); }, 0).toLocaleString('en-IN'));
  txt('st-sells',  appr.reduce(function(s,b){ return s + (b.quantity||0); }, 0));
  txt('st-total',  allBk.length);
  txt('st-pend',   pend);
  txt('st-appr',   appr.length);
  txt('st-reje',   allBk.filter(function(b){ return b.approval_status === 'rejected'; }).length);
  txt('sb-pend',   pend);
  if (pend > 0){ txt('mn-pend', pend); show('mn-pend'); } else { hide('mn-pend'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER + SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilt(f, el) {
  curFilt = f;
  document.querySelectorAll('.ftab').forEach(function(b){ b.classList.remove('active'); });
  if (el) el.classList.add('active');
  applyFilt();
}

function doSearch(v){ curQ = v.toLowerCase(); applyFilt(); }

function applyFilt() {
  filt = allBk.filter(function(b) {
    if (curFilt !== 'all' && b.approval_status !== curFilt) return false;
    if (curQ) {
      var h = [b.name, b.email, b.booking_id, b.transaction_id, b.phone].join(' ').toLowerCase();
      if (h.indexOf(curQ) === -1) return false;
    }
    return true;
  });
  BK = {};
  filt.forEach(function(b,i){ BK[i] = b; });
  renderMain();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLES + CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMain() {
  if (!filt.length) {
    var msg = curQ || curFilt !== 'all' ? 'No results match your search.' : 'No bookings yet.';
    html('tbl-main', emptyState('ğŸŸï¸', msg, ''));
    html('cards-main', emptyState('ğŸŸï¸', msg, ''));
    return;
  }
  html('tbl-main', buildTable(filt));
  html('cards-main', buildCards(filt));
}

function renderSub(status) {
  var rows = allBk.filter(function(b){ return b.approval_status === status; });
  var ico  = status === 'approved' ? 'âœ…' : 'âŒ';
  var msg  = 'No ' + status + ' bookings.';
  html('tbl-' + status,   rows.length ? buildTable(rows) : emptyState(ico, msg, ''));
  html('cards-' + status, rows.length ? buildCards(rows) : emptyState(ico, msg, ''));
}

// â”€â”€ Desktop Table â”€â”€
function buildTable(rows) {
  var head = '<thead><tr>' +
    '<th><input type="checkbox" title="Select all" onchange="selAllRows(this)" id="chk-all"></th>' +
    '<th>#</th><th>Booking ID</th><th>Name</th><th>Email</th>' +
    '<th>Qty</th><th>Amount</th><th>UTR</th><th>Submitted</th><th>Status</th><th>Actions</th>' +
    '</tr></thead>';
  var body = rows.map(function(b, i) {
    BK[i] = b;
    var dt  = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'short'}) : 'â€”';
    var pnd = b.approval_status === 'pending';
    var inC = cmpIds.indexOf(b.id) !== -1;
    var inS = selSet.has(b.id);
    var url = ssUrl(b.screenshot_url);
    return '<tr class="' + (inS ? 'selected' : '') + '" id="row-' + esc(b.id) + '">' +
      '<td><input type="checkbox" data-id="' + esc(b.id) + '" onchange="onRowChk(this)" ' + (inS ? 'checked' : '') + '></td>' +
      '<td style="color:var(--t3);font-size:.72rem">' + (i+1) + '</td>' +
      '<td><span class="td-mono">' + esc(b.booking_id||'â€”') + '</span></td>' +
      '<td class="td-name">' + esc(b.name||'â€”') + '</td>' +
      '<td class="td-muted">' + esc(b.email||'â€”') + '</td>' +
      '<td style="font-weight:700;text-align:center">' + (b.quantity||'â€”') + '</td>' +
      '<td class="td-amt">â‚¹' + (b.total_amount||'â€”') + '</td>' +
      '<td><span class="td-mono">' + esc(b.transaction_id||'â€”') + '</span></td>' +
      '<td style="font-size:.72rem;color:var(--t3)">' + dt + '</td>' +
      '<td>' + mkPill(b.approval_status) + '</td>' +
      '<td>' +
        '<div style="display:flex;gap:4px;flex-wrap:wrap">' +
          '<button class="btn btn-ghost btn-sm" onclick="openDet(' + i + ')">ğŸ‘ View</button>' +
          (url ? '<button class="btn btn-blue btn-sm" onclick="openLB(' + i + ')">ğŸ–¼</button>' : '') +
          '<button class="btn btn-amber btn-sm ' + (inC ? 'on' : '') + '" onclick="togCmp(\'' + esc(b.id) + '\')">âš–ï¸</button>' +
          (pnd ? '<button class="btn btn-green btn-sm" onclick="doStatus(\'' + esc(b.id) + '\',\'approved\')">âœ…</button>' +
                 '<button class="btn btn-red   btn-sm" onclick="doStatus(\'' + esc(b.id) + '\',\'rejected\')">âŒ</button>' : '') +
          '<button class="btn btn-red btn-sm" onclick="askDel1(\'' + esc(b.id) + '\')" title="Delete">' +
            '<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M9 6V4h6v2"/></svg>' +
          '</button>' +
        '</div>' +
      '</td>' +
    '</tr>';
  }).join('');
  return '<div class="tbl-scroll"><table>' + head + '<tbody>' + body + '</tbody></table></div>';
}

// â”€â”€ Mobile Cards â”€â”€
function buildCards(rows) {
  return rows.map(function(b, i) {
    BK[i] = b;
    var dt  = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'short'}) : 'â€”';
    var pnd = b.approval_status === 'pending';
    var url = ssUrl(b.screenshot_url);
    var inS = selSet.has(b.id);
    return '<div class="bk-card ' + (inS ? 'selected' : '') + '" id="mcard-' + esc(b.id) + '">' +
      '<div class="bk-card-head">' +
        '<div>' +
          '<div class="bk-card-name">' + esc(b.name||'â€”') + '</div>' +
          '<div class="bk-card-id">' + esc(b.booking_id||'â€”') + '</div>' +
        '</div>' +
        mkPill(b.approval_status) +
      '</div>' +
      '<div class="bk-card-body">' +
        bkf('Email',  esc(b.email||'â€”'),  false) +
        bkf('Phone',  b.phone||'â€”',        false) +
        bkf('Tickets', (b.quantity||'â€”') + ' tickets', false) +
        bkf('Amount', 'â‚¹' + (b.total_amount||'â€”'), true) +
        bkf('UTR',    b.transaction_id||'â€”', false) +
        bkf('Date',   dt,                  false) +
      '</div>' +
      '<div class="bk-card-foot">' +
        '<button class="btn btn-ghost btn-sm" onclick="openDet(' + i + ')">ğŸ‘ View</button>' +
        (url ? '<button class="btn btn-blue btn-sm" onclick="openLB(' + i + ')">ğŸ–¼ Screenshot</button>' : '') +
        (pnd ? '<button class="btn btn-green btn-sm" onclick="doStatus(\'' + esc(b.id) + '\',\'approved\')">âœ… Approve</button>' +
               '<button class="btn btn-red   btn-sm" onclick="doStatus(\'' + esc(b.id) + '\',\'rejected\')">âŒ Reject</button>' : '') +
        '<button class="btn btn-red btn-sm" onclick="askDel1(\'' + esc(b.id) + '\')">ğŸ—‘ Delete</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function bkf(label, val, hi) {
  return '<div class="bk-field"><label>' + label + '</label><span' + (hi ? ' class="hi"' : '') + '>' + val + '</span></div>';
}

function mkPill(s) {
  var map = { pending:['pill-pending','â³'], approved:['pill-approved','âœ…'], rejected:['pill-rejected','âŒ'] };
  var m = map[s] || map.pending;
  return '<span class="pill ' + m[0] + '"><span class="pill-dot"></span>' + (s||'pending') + '</span>';
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECKBOXES + SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onRowChk(chk) {
  var id = chk.getAttribute('data-id');
  if (chk.checked) selSet.add(id); else selSet.delete(id);
  var row   = document.getElementById('row-' + id);
  var mcard = document.getElementById('mcard-' + id);
  if (row)   row.classList.toggle('selected', chk.checked);
  if (mcard) mcard.classList.toggle('selected', chk.checked);
  syncSelBar();
}

function selAllRows(masterChk) {
  document.querySelectorAll('input[data-id]').forEach(function(c) {
    c.checked = masterChk.checked;
    var id = c.getAttribute('data-id');
    if (masterChk.checked) selSet.add(id); else selSet.delete(id);
    var row = document.getElementById('row-' + id);
    if (row) row.classList.toggle('selected', masterChk.checked);
  });
  syncSelBar();
}

function selAll(on) {
  selSet.clear();
  document.querySelectorAll('input[data-id]').forEach(function(c) {
    c.checked = on;
    if (on) selSet.add(c.getAttribute('data-id'));
    var row = document.getElementById('row-' + c.getAttribute('data-id'));
    if (row) row.classList.toggle('selected', on);
  });
  var mc = document.getElementById('chk-all'); if (mc) mc.checked = on;
  syncSelBar();
}

function syncSelBar() {
  var n = selSet.size;
  if (n > 0) {
    txt('sel-info', n + ' booking' + (n > 1 ? 's' : '') + ' selected');
    show('sel-bar');
  } else {
    hide('sel-bar');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDet(idx) {
  var b = BK[idx]; if (!b) return;
  detBk = b;

  txt('det-title', 'Booking â€” ' + (b.booking_id || ''));
  txt('det-sub', mkPill(b.approval_status));
  // swap innerHTML for sub since it has HTML
  $('det-sub').innerHTML = mkPill(b.approval_status);

  var pairs = [
    ['Name', b.name], ['Email', b.email],
    ['Phone', b.phone], ['Booking ID', b.booking_id],
    ['Tickets', (b.quantity||'â€”') + ' Ã— â‚¹100'], ['Total Amount', 'â‚¹' + (b.total_amount||'â€”')],
    ['Event', b.event_name], ['Date & Time', (b.event_date||'â€”') + ' Â· ' + (b.event_time||'â€”')],
    ['Venue', b.venue], ['UTR / Transaction ID', b.transaction_id],
    ['Status', b.approval_status],
    ['Submitted At', b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN') : 'â€”']
  ];
  html('det-fields', pairs.map(function(p, i) {
    return '<div class="det-field' + (i >= pairs.length - 2 ? ' span2' : '') + '">' +
      '<label>' + p[0] + '</label>' +
      '<span>' + esc(String(p[1] == null ? 'â€”' : p[1])) + '</span></div>';
  }).join(''));

  var url = ssUrl(b.screenshot_url);
  if (url) {
    $('det-ss-img').src   = url;
    $('det-ss-link').href = url;
    show('det-ss-wrap'); show('det-ss-btn');
  } else {
    hide('det-ss-wrap'); hide('det-ss-btn');
  }

  var pnd = b.approval_status === 'pending';
  $('det-approve').style.display = pnd ? '' : 'none';
  $('det-reject').style.display  = pnd ? '' : 'none';
  show('ov-det');
}

function closeDet() { hide('ov-det'); detBk = null; }
async function detAction(status) {
  if (!detBk) return;
  var id = detBk.id; closeDet();
  await doStatus(id, status);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLB(idx) {
  var b = BK[idx]; if (!b) return;
  var url = ssUrl(b.screenshot_url); if (!url) return;
  _lb(url, b.name || '');
}
function openLB_id(prefix) {
  var img = $(prefix + '-ss-img'); if (!img || !img.src) return;
  _lb(img.src, '');
}
function openLB_f(fidx) {
  var f = FM[fidx]; if (!f) return;
  _lb(f.url, f.name);
}
function _lb(src, label) {
  $('lb-img').src = src;
  $('lb-img').classList.remove('zm');
  txt('lb-cap', (label ? label + ' â€” ' : '') + 'Click to zoom Â· Scroll when zoomed');
  $('lb-orig').onclick = function(){ window.open(src, '_blank'); };
  show('lb');
  document.body.style.overflow = 'hidden';
}
function closeLB() { hide('lb'); $('lb-img').classList.remove('zm'); document.body.style.overflow = ''; }
function toggleZoom() {
  var img = $('lb-img');
  img.classList.toggle('zm');
  txt('lb-cap', img.classList.contains('zm') ? 'Zoomed â€” click to zoom out' : 'Click to zoom');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togCmp(id) {
  var i = cmpIds.indexOf(id);
  if (i !== -1) { cmpIds.splice(i, 1); }
  else {
    if (cmpIds.length >= 2) { toast('Max 2 bookings for compare', true); return; }
    cmpIds.push(id);
  }
  syncCmpBar(); applyFilt();
}
function syncCmpBar() {
  if (!cmpIds.length) { hide('cmp-bar'); return; }
  show('cmp-bar');
  html('cmp-tags', cmpIds.map(function(id) {
    var b = BKID[id];
    return '<span class="cmp-tag">' + esc(b ? (b.booking_id||b.name||id.slice(0,8)) : id.slice(0,8)) + '</span>';
  }).join(''));
  var btn = $('cmp-go');
  btn.disabled = cmpIds.length < 2;
  btn.textContent = cmpIds.length < 2 ? 'Pick 1 more' : 'Compare â†’';
}
function clearCmp() { cmpIds = []; syncCmpBar(); applyFilt(); }
function openCmp() {
  if (cmpIds.length < 2) return;
  var a = BKID[cmpIds[0]], b = BKID[cmpIds[1]]; if (!a||!b) return;
  var KEYS = [
    ['Name','name'],['Email','email'],['Phone','phone'],
    ['Booking ID','booking_id'],['Tickets','quantity'],['Amount','total_amount'],
    ['UTR','transaction_id'],['Event','event_name'],
    ['Date','event_date'],['Venue','venue'],['Status','approval_status'],
    ['Submitted','submitted_at']
  ];
  function col(main, other) {
    var rows = KEYS.map(function(p) {
      var va = main[p[1]] != null ? main[p[1]] : 'â€”';
      var vb = other[p[1]] != null ? other[p[1]] : 'â€”';
      if (p[1]==='submitted_at') { va=va!=='â€”'?new Date(va).toLocaleString('en-IN'):'â€”'; vb=vb!=='â€”'?new Date(vb).toLocaleString('en-IN'):'â€”'; }
      if (p[1]==='total_amount') { va=va!=='â€”'?'â‚¹'+va:'â€”'; vb=vb!=='â€”'?'â‚¹'+vb:'â€”'; }
      var diff = String(va) !== String(vb);
      return '<div class="cmp-row' + (diff?' diff':'') + '"><label>' + p[0] + '</label><span>' + esc(String(va)) + '</span></div>';
    }).join('');
    var url = ssUrl(main.screenshot_url);
    var pfx = 'cmp' + esc(main.booking_id||'A').replace(/\W/g,'');
    var ssH = url
      ? '<img class="ss-img" id="' + pfx + '-ss-img" src="' + esc(url) + '" onclick="openLB_id(\'' + pfx + '\')" style="width:100%;margin-top:.65rem">'
      : '<div style="font-size:.72rem;color:var(--t4);font-style:italic;margin-top:.65rem">No screenshot</div>';
    return '<div class="cmp-col"><div class="cmp-col-hd">' + esc(main.booking_id||main.name||'Booking') + '</div>' + rows + ssH + '</div>';
  }
  html('cmp-grid', col(a,b) + col(b,a));
  show('ov-cmp');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SET STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doStatus(id, status) {
  try {
    var res = await fetch(SB + '/rest/v1/ticket_bookings?id=eq.' + encodeURIComponent(id), {
      method: 'PATCH',
      headers: Object.assign({}, AH, { 'Content-Type':'application/json', Prefer:'return=minimal' }),
      body: JSON.stringify({ approval_status:status, approved_at:new Date().toISOString(), approved_by:'admin' })
    });
    if (!res.ok) { toast('Update failed: ' + res.status, true); return; }
    for (var i=0; i<allBk.length; i++) {
      if (allBk[i].id === id) { allBk[i].approval_status = status; break; }
    }
    if (BKID[id]) BKID[id].approval_status = status;
    updateStats(); applyFilt();
    if (curPage==='approved'||curPage==='rejected') renderSub(curPage);
    toast(status==='approved' ? 'âœ… Booking approved!' : 'âŒ Booking rejected.');
  } catch(e) { toast('Error: ' + e.message, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE â€” single, bulk, clear all
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function askDel1(id) {
  var b = BKID[id];
  var nm = b ? (b.name || b.booking_id || 'booking') : 'booking';
  txt('cf-ico', 'ğŸ—‘ï¸');
  txt('cf-h',   'Delete Booking?');
  html('cf-p',  'Permanently delete booking for <span class="hi">' + esc(nm) + '</span>. This cannot be undone.');
  hide('cf-count');
  txt('cf-ok',  'ğŸ—‘ï¸ Delete');
  cfCb = function(){ doDel([id]); };
  show('ov-cf');
}

function askBulkDel() {
  var n = selSet.size;
  if (!n) { toast('No bookings selected', true); return; }
  txt('cf-ico', 'ğŸ—‘ï¸');
  txt('cf-h',   'Delete ' + n + ' Booking' + (n>1?'s':'') + '?');
  html('cf-p',  'You are about to permanently delete <span class="hi">' + n + ' booking' + (n>1?'s':'') + '</span>. This cannot be undone.');
  $('cf-count').textContent = n + ' booking' + (n>1?'s':'') + ' will be deleted';
  show('cf-count');
  txt('cf-ok',  'ğŸ—‘ï¸ Delete ' + n);
  cfCb = function(){ doDel([...selSet]); };
  show('ov-cf');
}

function askClearAll() {
  var ids = filt.map(function(b){ return b.id; });
  if (!ids.length) { toast('Nothing to delete', true); return; }
  var label = curFilt === 'all' ? 'all bookings' : 'all ' + curFilt + ' bookings';
  txt('cf-ico', 'âš ï¸');
  txt('cf-h',   'Clear All?');
  html('cf-p',  'Delete <span class="hi">' + ids.length + ' ' + label + '</span>? This is permanent and cannot be undone.');
  $('cf-count').textContent = ids.length + ' booking' + (ids.length>1?'s':'') + ' in current view';
  show('cf-count');
  txt('cf-ok',  'ğŸ—‘ï¸ Delete All ' + ids.length);
  cfCb = function(){ doDel(ids); };
  show('ov-cf');
}

function cfOk()  { closeOv('ov-cf'); if (cfCb) cfCb(); }

async function doDel(ids) {
  if (!ids.length) return;
  // delete in chunks of 100 to avoid URL length limit
  var chunks = [];
  for (var i=0; i<ids.length; i+=100) chunks.push(ids.slice(i,i+100));
  try {
    for (var c=0; c<chunks.length; c++) {
      var res = await fetch(SB + '/rest/v1/ticket_bookings?id=in.(' + chunks[c].join(',') + ')', {
        method: 'DELETE',
        headers: Object.assign({}, AH, { Prefer:'return=minimal' })
      });
      if (!res.ok) throw new Error('Delete failed: ' + res.status);
    }
    // remove from local state
    var gone = {};
    ids.forEach(function(id){ gone[id] = true; });
    allBk = allBk.filter(function(b){ return !gone[b.id]; });
    ids.forEach(function(id){ delete BKID[id]; selSet.delete(id); });
    updateStats(); applyFilt();
    if (curPage==='approved'||curPage==='rejected') renderSub(curPage);
    syncSelBar();
    toast('ğŸ—‘ï¸ Deleted ' + ids.length + ' booking' + (ids.length>1?'s':'') + ' successfully');
  } catch(e) { toast(e.message, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENSHOTS GALLERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSsCount() {
  try {
    var res = await fetch(SB + '/storage/v1/object/list/' + BUCKET, {
      method:'POST',
      headers:Object.assign({},AH,{'Content-Type':'application/json'}),
      body:JSON.stringify({limit:200,offset:0})
    });
    if (!res.ok) return;
    var files = await res.json();
    txt('sb-ssc', files.length);
  } catch(_){}
}

async function loadSS() {
  html('gal-area', '<div class="loader"><span class="spin"></span>Loading screenshotsâ€¦</div>');
  try {
    var res = await fetch(SB + '/storage/v1/object/list/' + BUCKET, {
      method:'POST',
      headers:Object.assign({},AH,{'Content-Type':'application/json'}),
      body:JSON.stringify({limit:200,offset:0,sortBy:{column:'created_at',order:'desc'}})
    });
    if (!res.ok) throw new Error('Storage error ' + res.status);
    var files = await res.json();
    txt('sb-ssc', files.length);
    txt('gal-info', files.length + ' screenshot' + (files.length!==1?'s':'') + ' uploaded');
    if (!files.length) { html('gal-area', emptyState('ğŸ–¼ï¸','No screenshots uploaded yet.', 'Screenshots appear here after users submit their payment proof')); return; }
    FM = {};
    files.forEach(function(f,i){
      var url = PUBBASE + encodeURIComponent(f.name);
      var linked = null;
      for (var j=0; j<allBk.length; j++){
        var u = ssUrl(allBk[j].screenshot_url);
        if (u && (u.indexOf(encodeURIComponent(f.name))!==-1 || u.indexOf(f.name)!==-1)) { linked=allBk[j]; break; }
      }
      FM[i] = {url:url, name:f.name, linked:linked, meta:f.metadata, created:f.created_at};
    });
    html('gal-area', '<div class="gal-grid">' + files.map(function(f,i){ return galCard(i); }).join('') + '</div>');
  } catch(e) { html('gal-area', emptyState('âš ï¸', e.message, '')); }
}

function galCard(i) {
  var f = FM[i], url = f.url, linked = f.linked;
  var size = f.meta&&f.meta.size ? fmtBytes(f.meta.size) : '';
  var date = f.created ? new Date(f.created).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'short'}) : '';
  var bclr = {approved:['#10b981','#000'], pending:['#f59e0b','#000'], rejected:['#ef4444','#fff']};
  var badge = linked ? '<span class="gal-status" style="background:' + (bclr[linked.approval_status]||['#888','#fff'])[0] + ';color:' + (bclr[linked.approval_status]||['#888','#fff'])[1] + '">' + esc(linked.approval_status) + '</span>' : '';
  var detIdx = -1;
  if (linked) {
    filt.forEach(function(b,j){ if(b.id===linked.id) detIdx=j; });
    if (detIdx===-1) { var k=9000+i; BK[k]=linked; detIdx=k; }
  }
  var linkRow = linked
    ? '<div class="gal-link" onclick="event.stopPropagation();openDet(' + detIdx + ')">ğŸ”— ' + esc(linked.booking_id||linked.name||'Booking') + '</div>'
    : '<div class="gal-unlinked">Not linked to booking</div>';
  var bookBtn = linked ? '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openDet(' + detIdx + ')">ğŸ“‹</button>' : '';
  return '<div class="gal-card" onclick="openLB_f(' + i + ')">' +
    '<div class="gal-img-wrap">' +
      '<img class="gal-img loading" src="' + esc(url) + '" onload="this.classList.remove(\'loading\')" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'" alt="">' +
      '<div class="gal-no-img" style="display:none">ğŸ–¼ï¸</div>' + badge +
    '</div>' +
    '<div class="gal-body">' +
      '<div class="gal-name" title="' + esc(f.name) + '">' + esc(f.name) + '</div>' +
      '<div class="gal-meta">' + [size,date].filter(Boolean).join(' Â· ') + '</div>' +
      linkRow +
      '<div class="gal-acts">' +
        '<button class="btn btn-blue btn-sm" style="flex:1" onclick="event.stopPropagation();openLB_f(' + i + ')">ğŸ” Enlarge</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();window.open(\'' + esc(url) + '\',\'_blank\')">â†—</button>' +
        bookBtn +
      '</div>' +
    '</div>' +
  '</div>';
}
function fmtBytes(n){ if(n<1024)return n+' B'; if(n<1048576)return(n/1024).toFixed(1)+' KB'; return(n/1048576).toFixed(1)+' MB'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKET VERIFY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doVerify() {
  var q = $('vin').value.trim().toLowerCase();
  if (!q) { toast('Enter a Booking ID or UTR', true); return; }
  show('vres');
  var b = null;
  for (var i=0; i<allBk.length; i++) {
    var x = allBk[i];
    if ((x.booking_id||'').toLowerCase()===q || (x.transaction_id||'').toLowerCase()===q || (x.booking_id||'').toLowerCase().indexOf(q)!==-1) { b=x; break; }
  }
  if (!b) {
    html('vres', '<div class="verify-card"><div class="v-banner notfound"><div class="v-ico">ğŸš«</div><div><div class="v-title">Not Found</div><div class="v-msg">No booking matches "<strong>' + esc(q) + '</strong>".</div></div></div></div>');
    return;
  }
  var s   = b.approval_status || 'pending';
  var ico = {approved:'âœ…',pending:'â³',rejected:'âŒ'};
  var msg = {approved:'Valid ticket â€” approved for entry.',pending:'Pending approval â€” entry not yet confirmed.',rejected:'Ticket rejected â€” not valid for entry.'};
  var dt  = b.submitted_at ? new Date(b.submitted_at).toLocaleString('en-IN') : 'â€”';
  var url = ssUrl(b.screenshot_url);
  var vi  = 8000; BK[vi] = b;
  html('vres',
    '<div class="verify-card">' +
    '<div class="v-banner ' + s + '"><div class="v-ico">' + (ico[s]||'â³') + '</div><div><div class="v-title">' + s.toUpperCase() + '</div><div class="v-msg">' + (msg[s]||'') + '</div></div></div>' +
    '<div class="v-dg">' +
      vf('Name', esc(b.name||'â€”')) + vf('Email', esc(b.email||'â€”')) +
      vf('Phone', b.phone||'â€”') + vf('Booking ID', '<span style="font-family:var(--fm)">' + esc(b.booking_id||'â€”') + '</span>') +
      vf('Tickets', (b.quantity||'â€”') + ' ticket(s)') + vf('Amount', '<span style="color:var(--amber);font-weight:700">â‚¹' + (b.total_amount||'â€”') + '</span>') +
      vf('Event', esc(b.event_name||'â€”')) + vf('Venue', esc(b.venue||'â€”')) +
      vf('UTR', '<span style="font-family:var(--fm)">' + esc(b.transaction_id||'â€”') + '</span>') + vf('Submitted', esc(dt)) +
    '</div>' +
    (url ? '<div class="ss-block"><div class="ss-block-lbl">Payment Screenshot</div><img class="ss-img" id="vs-ss-img" src="' + esc(url) + '" onclick="openLB_id(\'vs-ss\')" alt="Screenshot"></div>' : '') +
    (s==='pending' ? '<div class="v-acts"><button class="btn btn-green btn-lg" onclick="doStatus(\'' + esc(b.id) + '\',\'approved\');setTimeout(doVerify,400)">âœ… Approve</button><button class="btn btn-red btn-lg" onclick="doStatus(\'' + esc(b.id) + '\',\'rejected\');setTimeout(doVerify,400)">âŒ Reject</button></div>' : '') +
    '</div>'
  );
}
function vf(l,v){ return '<div class="v-field"><label>' + l + '</label><span>' + v + '</span></div>'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function $(id){ return document.getElementById(id); }
function html(id,h){ var el=$(id); if(el) el.innerHTML=h; }
function txt(id,t){ var el=$(id); if(el) el.textContent=t; }
function show(id){ var el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ var el=$(id); if(el) el.classList.add('hidden'); }
function closeOv(id){ hide(id); }

function loader(){ return '<div class="loader"><span class="spin"></span>Loadingâ€¦</div>'; }
function emptyState(ico, msg, sub) {
  return '<div class="empty-state"><div class="empty-ico">' + ico + '</div><div class="empty-txt">' + msg + '</div>' + (sub?'<div class="empty-sub">'+sub+'</div>':'') + '</div>';
}

function toast(msg, isErr) {
  var el = $('toast'), dot = el.querySelector('.t-dot'), msgEl = $('toast-msg');
  msgEl.textContent = msg;
  el.className = 'toast show ' + (isErr ? 'err' : 'ok');
  clearTimeout(el._t);
  el._t = setTimeout(function(){ el.classList.remove('show'); }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAY CLOSE / KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
['ov-det','ov-cmp','ov-cf'].forEach(function(id) {
  $(id).addEventListener('click', function(e){ if(e.target===this) closeOv(id); });
});
$('lb').addEventListener('click', function(e){ if(e.target===$('lb')) closeLB(); });
document.addEventListener('keydown', function(e){
  if (e.key==='Escape'){ closeLB(); closeDet(); closeOv('ov-cmp'); closeOv('ov-cf'); }
});

// Auto-refresh every 60s
setInterval(function(){ loadBookings(); }, 60000);
</script>
</body>
</html>
